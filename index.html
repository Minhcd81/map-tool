<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Báº£n Ä‘á»“ TSBÄ & TSSS - BIDV (Enhanced)</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }

    .controls {
      position: absolute;
      top: 10px;
      left: 60px;
      background-color: rgba(0, 125, 120, 0.95);
      padding: 15px;
      border-radius: 10px;
      color: white;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 300px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .controls input {
      margin: 6px 0;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 220px;
      font-size: 14px;
    }

    .controls button {
      background-color: #f2c94c;
      color: black;
      border: none;
      padding: 8px 12px;
      margin: 4px 2px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      font-size: 12px;
    }

    .controls button:hover {
      background-color: #f0b90b;
    }

    .google-maps-section {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .save-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.3);
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .distance-display {
      margin-left: 8px;
      color: #f2c94c;
      font-weight: bold;
      font-size: 13px;
    }

    .map-type-selector {
      margin: 10px 0;
    }

    .map-type-selector select {
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: white;
      color: black;
    }

    .coordinate-info {
      background-color: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      font-size: 12px;
    }

    #click-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0, 125, 120, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
    }

    .api-status {
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      font-size: 12px;
      text-align: center;
    }

    .api-connected { background-color: rgba(76, 175, 80, 0.3); }
    .api-error { background-color: rgba(244, 67, 54, 0.3); }

    .my-maps-url {
      background-color: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      word-break: break-all;
      font-size: 11px;
    }

    .instruction {
      background-color: rgba(255,193,7,0.2);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 11px;
      border-left: 3px solid #f2c94c;
    }

    .screenshot-preview {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      max-width: 90vw;
      max-height: 90vh;
    }

    .screenshot-preview img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 5px;
    }

    .preview-controls {
      margin-top: 15px;
      text-align: center;
    }

    .preview-controls button {
      background-color: #007d78;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 5px;
      cursor: pointer;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007d78;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="controls">
    <!-- API Status -->
    <div id="api-status" class="api-status api-error">
      âš ï¸ ChÆ°a káº¿t ná»‘i Google Maps API
    </div>

    <!-- HÆ°á»›ng dáº«n setup -->
    <div class="instruction">
      <strong>ğŸ“‹ HÆ°á»›ng dáº«n setup:</strong><br>
      1. Thay YOUR_API_KEY báº±ng API key thá»±c<br>
      2. Táº¡o Google My Map Ä‘á»ƒ lÆ°u dá»¯ liá»‡u<br>
      3. Chia sáº» cÃ´ng khai Ä‘á»ƒ nhiá»u ngÆ°á»i xem
    </div>

    <div><strong>TSBÄ:</strong><br>
      <input id="tsbd" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
    </div>

    <div><strong>TSSS1:</strong><br>
      <input id="tsss1" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
      <span class="distance-display" id="dist-tsss1"></span>
    </div>

    <div><strong>TSSS2:</strong><br>
      <input id="tsss2" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
      <span class="distance-display" id="dist-tsss2"></span>
    </div>

    <div><strong>TSSS3:</strong><br>
      <input id="tsss3" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
      <span class="distance-display" id="dist-tsss3"></span>
    </div>

    <div class="map-type-selector">
      <strong>Loáº¡i báº£n Ä‘á»“:</strong><br>
      <select id="mapType" onchange="changeMapType()">
        <option value="roadmap">ÄÆ°á»ng phá»‘</option>
        <option value="satellite">Vá»‡ tinh</option>
        <option value="hybrid">Káº¿t há»£p</option>
        <option value="terrain">Äá»‹a hÃ¬nh</option>
      </select>
    </div>

    <div class="coordinate-info">
      <strong>Cháº¿ Ä‘á»™:</strong> <span id="input-mode">Chá»n TSBÄ</span><br>
      <small>Nháº¥p vÃ o báº£n Ä‘á»“ Ä‘á»ƒ Ä‘áº·t tá»a Ä‘á»™</small>
    </div>

    <div class="button-group">
      <button onclick="updateMarkers()">ğŸ”„ Cáº­p nháº­t</button>
      <button onclick="clearAll()">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
      <button onclick="centerMap()">ğŸ¯ CÄƒn giá»¯a</button>
      <button onclick="getCurrentLocation()">ğŸ“ Vá»‹ trÃ­ hiá»‡n táº¡i</button>
    </div>

    <!-- Screenshot Section -->
    <div class="save-section">
      <strong>ğŸ“· Chá»¥p áº£nh báº£n Ä‘á»“:</strong>
      <div class="button-group">
        <button onclick="takeScreenshot('png')">ğŸ–¼ï¸ PNG</button>
        <button onclick="takeScreenshot('jpg')">ğŸ“¸ JPG</button>
        <button onclick="takeScreenshotHD()">ğŸ¯ HD PNG</button>
      </div>
      <div class="coordinate-info">
        <input type="checkbox" id="hide-controls" checked />
        <label for="hide-controls">áº¨n báº£ng Ä‘iá»u khiá»ƒn khi chá»¥p</label><br>
        <input type="checkbox" id="add-watermark" />
        <label for="add-watermark">ThÃªm watermark BIDV</label>
      </div>
    </div>

    <!-- Google My Maps Integration -->
    <div class="google-maps-section">
      <strong>ğŸ—ºï¸ Google My Maps:</strong>
      <div class="button-group">
        <button onclick="createMyMap()">â• Táº¡o My Map</button>
        <button onclick="openMyMaps()">ğŸ”— Má»Ÿ My Maps</button>
        <button onclick="shareMyMap()">ğŸ“¤ Chia sáº»</button>
      </div>
      
      <div id="my-maps-info" class="my-maps-url" style="display: none;">
        <strong>My Maps URL:</strong><br>
        <a id="my-maps-link" href="#" target="_blank" style="color: #f2c94c;">ChÆ°a cÃ³ link</a>
      </div>
    </div>

    <!-- Save/Load Section -->
    <div class="save-section">
      <strong>ğŸ’¾ LÆ°u/Táº£i dá»¯ liá»‡u:</strong>
      <div class="button-group">
        <button onclick="exportToCSV()">ğŸ“„ CSV</button>
        <button onclick="exportToExcel()">ğŸ“Š Excel</button>
        <button onclick="exportToGoogleSheets()">ğŸ“— Google Sheets</button>
        <button onclick="loadFromFile()">ğŸ“ Táº£i file</button>
      </div>
      <input type="file" id="file-input" accept=".csv,.xlsx" style="display: none;" onchange="handleFileLoad(event)" />
    </div>

    <!-- URL Sharing -->
    <div class="save-section">
      <strong>ğŸ”— Chia sáº» URL:</strong>
      <div class="button-group">
        <button onclick="generateShareURL()">ğŸ”— Táº¡o link</button>
        <button onclick="copyToClipboard()">ğŸ“‹ Copy</button>
      </div>
      <div id="share-url" class="my-maps-url" style="display: none;">
        <input id="share-url-input" type="text" style="width: 100%; font-size: 10px;" readonly />
      </div>
    </div>
  </div>

  <div id="click-info">
    Nháº¥p vÃ o báº£n Ä‘á»“ Ä‘á»ƒ Ä‘áº·t tá»a Ä‘á»™ cho: <span id="current-mode">TSBÄ</span>
  </div>

  <div id="map"></div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <span>Äang chá»¥p áº£nh báº£n Ä‘á»“...</span>
  </div>

  <!-- Screenshot preview -->
  <div id="screenshot-preview" class="screenshot-preview">
    <div style="text-align: center; margin-bottom: 15px; color: #007d78;">
      <h3>ğŸ“· Xem trÆ°á»›c áº£nh chá»¥p</h3>
    </div>
    <img id="preview-image" src="" alt="Screenshot Preview" />
    <div class="preview-controls">
      <button onclick="downloadPreviewImage()">ğŸ’¾ Táº£i xuá»‘ng</button>
      <button onclick="shareImage()">ğŸ“¤ Chia sáº»</button>
      <button onclick="closePreview()">âŒ ÄÃ³ng</button>
    </div>
  </div>

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- HTML2Canvas for screenshot -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    let map;
    let markers = {};
    let currentInputMode = 'tsbd';
    let bounds;
    let isGoogleMapsLoaded = false;

    // Dá»¯ liá»‡u máº·c Ä‘á»‹nh (HÃ  Ná»™i)
    const defaultCenter = { lat: 21.02971, lng: 105.85712 };

    // Khá»Ÿi táº¡o Google Maps
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 17,
        center: defaultCenter,
        mapTypeId: 'roadmap'
      });

      bounds = new google.maps.LatLngBounds();
      isGoogleMapsLoaded = true;

      // Cáº­p nháº­t tráº¡ng thÃ¡i API
      document.getElementById('api-status').className = 'api-status api-connected';
      document.getElementById('api-status').innerHTML = 'âœ… Google Maps API Ä‘Ã£ káº¿t ná»‘i';

      // Láº¯ng nghe sá»± kiá»‡n click trÃªn báº£n Ä‘á»“
      map.addListener('click', (event) => {
        const lat = event.latLng.lat();
        const lng = event.latLng.lng();
        
        document.getElementById(currentInputMode).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        switchToNextInput();
        updateMarkers();
      });

      updateInputModeDisplay();
      loadFromURL(); // Load dá»¯ liá»‡u tá»« URL náº¿u cÃ³
    }

    // Xá»­ lÃ½ khi Google Maps API khÃ´ng load Ä‘Æ°á»£c
    window.gm_authFailure = function() {
      document.getElementById('api-status').className = 'api-status api-error';
      document.getElementById('api-status').innerHTML = 'âŒ Google Maps API Key khÃ´ng há»£p lá»‡';
    };

    // Load dá»¯ liá»‡u tá»« URL parameters
    function loadFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const data = urlParams.get('data');
      
      if (data) {
        try {
          const decoded = JSON.parse(atob(data));
          Object.keys(decoded).forEach(key => {
            if (document.getElementById(key)) {
              document.getElementById(key).value = decoded[key];
            }
          });
          updateMarkers();
        } catch (e) {
          console.error('Lá»—i load tá»« URL:', e);
        }
      }
    }

    // Táº¡o URL chia sáº»
    function generateShareURL() {
      const data = {
        tsbd: document.getElementById('tsbd').value,
        tsss1: document.getElementById('tsss1').value,
        tsss2: document.getElementById('tsss2').value,
        tsss3: document.getElementById('tsss3').value
      };
      
      const encoded = btoa(JSON.stringify(data));
      const url = `${window.location.origin}${window.location.pathname}?data=${encoded}`;
      
      document.getElementById('share-url').style.display = 'block';
      document.getElementById('share-url-input').value = url;
    }

    // Copy to clipboard
    function copyToClipboard() {
      const input = document.getElementById('share-url-input');
      if (input.value) {
        input.select();
        document.execCommand('copy');
        alert('âœ… ÄÃ£ copy link chia sáº»!');
      } else {
        alert('âš ï¸ ChÆ°a cÃ³ link Ä‘á»ƒ copy!');
      }
    }

    // Láº¥y vá»‹ trÃ­ hiá»‡n táº¡i
    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById(currentInputMode).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            updateMarkers();
            map.setCenter({ lat, lng });
          },
          (error) => {
            alert('KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ hiá»‡n táº¡i: ' + error.message);
          }
        );
      } else {
        alert('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ geolocation');
      }
    }

    // Táº¡o Google My Map
    function createMyMap() {
      const data = collectData();
      if (data.length === 0) {
        alert('Vui lÃ²ng nháº­p Ã­t nháº¥t má»™t tá»a Ä‘á»™ trÆ°á»›c!');
        return;
      }

      let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>BIDV - Báº£n Ä‘á»“ TSBÄ &amp; TSSS</name>
    <description>Táº¡o tá»« BIDV Map Tool</description>
    <Style id="tsbd-style">
      <IconStyle>
        <color>ff007d78</color>
        <scale>1.2</scale>
      </IconStyle>
    </Style>
    <Style id="tsss-style">
      <IconStyle>
        <color>ff4cc9f2</color>
        <scale>1.0</scale>
      </IconStyle>
    </Style>`;

      data.forEach(item => {
        const styleId = item['Loáº¡i'].includes('TSBÄ') ? 'tsbd-style' : 'tsss-style';
        kmlContent += `
    <Placemark>
      <name>${item['Loáº¡i']}</name>
      <description>
        Tá»a Ä‘á»™: ${item['VÄ© Ä‘á»™ (Latitude)']}, ${item['Kinh Ä‘á»™ (Longitude)']}
        ${item['Khoáº£ng cÃ¡ch tá»« TSBÄ'] ? `&lt;br/&gt;Khoáº£ng cÃ¡ch: ${item['Khoáº£ng cÃ¡ch tá»« TSBÄ']}` : ''}
        &lt;br/&gt;Thá»i gian: ${item['Thá»i gian']}
      </description>
      <styleUrl>#${styleId}</styleUrl>
      <Point>
        <coordinates>${item['Kinh Ä‘á»™ (Longitude)']},${item['VÄ© Ä‘á»™ (Latitude)']},0</coordinates>
      </Point>
    </Placemark>`;
      });

      kmlContent += `
  </Document>
</kml>`;

      // Táº¡o file KML vÃ  táº£i xuá»‘ng
      const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `BIDV_MyMap_${new Date().toISOString().split('T')[0]}.kml`;
      a.click();

      // Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n
      setTimeout(() => {
        alert(`âœ… File KML Ä‘Ã£ táº£i xuá»‘ng!

ğŸ“‹ HÆ°á»›ng dáº«n táº¡o My Map:
1. Truy cáº­p: https://mymaps.google.com
2. Nháº¥n "CREATE A NEW MAP"
3. Nháº¥n "Import" â†’ Chá»n file KML vá»«a táº£i
4. Äáº·t tÃªn vÃ  mÃ´ táº£ cho báº£n Ä‘á»“
5. Nháº¥n "Share" Ä‘á»ƒ chia sáº» cÃ´ng khai`);
      }, 1000);
    }

    // Má»Ÿ Google My Maps
    function openMyMaps() {
      window.open('https://mymaps.google.com', '_blank');
    }

    // Chia sáº» My Map
    function shareMyMap() {
      const mapUrl = prompt(`ğŸ”— Nháº­p URL Google My Maps cá»§a báº¡n:
(Láº¥y tá»« nÃºt "Share" trong My Maps)`, '');
      
      if (mapUrl && mapUrl.trim()) {
        document.getElementById('my-maps-info').style.display = 'block';
        document.getElementById('my-maps-link').href = mapUrl;
        document.getElementById('my-maps-link').textContent = 'Xem My Map â†’';
        
        // LÆ°u vÃ o localStorage
        localStorage.setItem('bidv-my-maps-url', mapUrl);
        
        alert('âœ… ÄÃ£ lÆ°u link My Maps!');
      }
    }

    // Export to Google Sheets
    function exportToGoogleSheets() {
      const data = collectData();
      if (data.length === 0) {
        alert('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!');
        return;
      }

      // Táº¡o CSV data
      const headers = Object.keys(data[0]).join(',');
      const csvData = data.map(row => Object.values(row).map(val => `"${val}"`).join(',')).join('\n');
      const csvContent = headers + '\n' + csvData;

      // Táº¡o Google Sheets URL
      const encodedData = encodeURIComponent(csvContent);
      const sheetsUrl = `https://docs.google.com/spreadsheets/create?usp=sharing`;
      
      // Copy CSV to clipboard
      navigator.clipboard.writeText(csvContent).then(() => {
        alert(`âœ… Dá»¯ liá»‡u CSV Ä‘Ã£ copy!

ğŸ“‹ HÆ°á»›ng dáº«n táº¡o Google Sheets:
1. Nháº¥n OK Ä‘á»ƒ má»Ÿ Google Sheets
2. DÃ¡n (Ctrl+V) dá»¯ liá»‡u Ä‘Ã£ copy
3. Chá»n "Data" â†’ "Split text to columns"
4. Chá»n "Comma" lÃ m delimiter`);
        
        window.open(sheetsUrl, '_blank');
      }).catch(() => {
        // Fallback náº¿u khÃ´ng cÃ³ clipboard API
        exportToCSV();
      });
    }

    // CÃ¡c hÃ m khÃ¡c giá»¯ nguyÃªn tá»« phiÃªn báº£n trÆ°á»›c...
    function switchToNextInput() {
      const modes = ['tsbd', 'tsss1', 'tsss2', 'tsss3'];
      const currentIndex = modes.indexOf(currentInputMode);
      const nextIndex = (currentIndex + 1) % modes.length;
      currentInputMode = modes[nextIndex];
      updateInputModeDisplay();
    }

    function updateInputModeDisplay() {
      const modeNames = {
        'tsbd': 'TSBÄ',
        'tsss1': 'TSSS 1',
        'tsss2': 'TSSS 2', 
        'tsss3': 'TSSS 3'
      };
      document.getElementById('input-mode').textContent = `Chá»n ${modeNames[currentInputMode]}`;
      document.getElementById('current-mode').textContent = modeNames[currentInputMode];
    }

    function changeMapType() {
      if (map) {
        const mapType = document.getElementById('mapType').value;
        map.setMapTypeId(mapType);
      }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return (R * c).toFixed(2);
    }

    function createCustomMarker(position, title, type, distance = null) {
      if (markers[type]) {
        markers[type].setMap(null);
      }

      const isTSBD = type === 'tsbd';
      const color = isTSBD ? '#007d78' : '#f2c94c';
      const bgColor = isTSBD ? '#f2c94c' : '#007d78';
      
      let labelText = title;
      if (distance) {
        labelText += `\n${distance} km`;
      }

      const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: labelText,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 20,
          fillColor: color,
          fillOpacity: 1,
          strokeColor: bgColor,
          strokeWeight: 3
        },
        label: {
          text: title,
          color: bgColor,
          fontWeight: 'bold',
          fontSize: '12px'
        }
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="color: black;">
            <h4>${title}</h4>
            <p>Tá»a Ä‘á»™: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}</p>
            ${distance ? `<p>Khoáº£ng cÃ¡ch tá»« TSBÄ: ${distance} km</p>` : ''}
          </div>
        `
      });

      marker.addListener('click', () => {
        Object.values(markers).forEach(m => {
          if (m.infoWindow) m.infoWindow.close();
        });
        infoWindow.open(map, marker);
      });

      marker.infoWindow = infoWindow;
      markers[type] = marker;
      
      return marker;
    }

    function updateMarkers() {
      if (!isGoogleMapsLoaded) return;

      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      let tsbdPos = null;
      bounds = new google.maps.LatLngBounds();

      if (inputs.tsbd.trim()) {
        try {
          const [lat, lng] = inputs.tsbd.split(',').map(x => parseFloat(x.trim()));
          if (!isNaN(lat) && !isNaN(lng)) {
            tsbdPos = { lat, lng };
            createCustomMarker(tsbdPos, "TSBÄ", "tsbd");
            bounds.extend(tsbdPos);
          }
        } catch (e) {
          console.error('Lá»—i tá»a Ä‘á»™ TSBÄ:', e);
        }
      }

      ['tsss1', 'tsss2', 'tsss3'].forEach((id, index) => {
        const distElement = document.getElementById(`dist-${id}`);
        
        if (inputs[id].trim()) {
          try {
            const [lat, lng] = inputs[id].split(',').map(x => parseFloat(x.trim()));
            if (!isNaN(lat) && !isNaN(lng)) {
              const pos = { lat, lng };
              let distance = null;
              
              if (tsbdPos) {
                distance = calculateDistance(tsbdPos.lat, tsbdPos.lng, lat, lng);
                distElement.textContent = `ğŸ“ ${distance} km`;
              } else {
                distElement.textContent = '';
              }
              
              createCustomMarker(pos, `TSSS ${index + 1}`, id, distance);
              bounds.extend(pos);
            }
          } catch (e) {
            console.error(`Lá»—i tá»a Ä‘á»™ ${id}:`, e);
            distElement.textContent = '';
          }
        } else {
          distElement.textContent = '';
        }
      });

      if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
        google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
          if (map.getZoom() > 18) {
            map.setZoom(18);
          }
        });
      }
    }

    function clearAll() {
      document.getElementById("tsbd").value = '';
      document.getElementById("tsss1").value = '';
      document.getElementById("tsss2").value = '';
      document.getElementById("tsss3").value = '';
      
      Object.values(markers).forEach(marker => {
        marker.setMap(null);
      });
      markers = {};
      
      ['dist-tsss1', 'dist-tsss2', 'dist-tsss3'].forEach(id => {
        document.getElementById(id).textContent = '';
      });
      
      currentInputMode = 'tsbd';
      updateInputModeDisplay();
    }

    function centerMap() {
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
      } else {
        map.setCenter(defaultCenter);
        map.setZoom(17);
      }
    }

    function exportToCSV() {
      const data = collectData();
      if (data.length === 0) {
        alert('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!');
        return;
      }

      const csvContent = data.map(row => 
        Object.values(row).map(val => `"${val}"`).join(',')
      ).join('\n');
      
      const headers = Object.keys(data[0]).map(key => `"${key}"`).join(',');
      const fullCSV = headers + '\n' + csvContent;

      const blob = new Blob(['\ufeff' + fullCSV], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `BIDV_ToaDo_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function exportToExcel() {
      const data = collectData();
      if (data.length === 0) {
        alert('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!');
        return;
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(data);
      
      const colWidths = Object.keys(data[0]).map(key => ({ wch: Math.max(key.length, 15) }));
      ws['!cols'] = colWidths;
      
      XLSX.utils.book_append_sheet(wb, ws, "Tá»a Ä‘á»™ BIDV");
      XLSX.writeFile(wb, `BIDV_ToaDo_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function collectData() {
      const data = [];
      const timestamp = new Date().toLocaleString('vi-VN');

      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      Object.entries(inputs).forEach(([key, value]) => {
        if (value.trim()) {
          const [lat, lng] = value.split(',').map(x => parseFloat(x.trim()));
          const type = key === 'tsbd' ? 'TSBÄ' : `TSSS ${key.slice(-1)}`;
          
          let distance = '';
          if (key !== 'tsbd' && inputs.tsbd.trim()) {
            const [tsbdLat, tsbdLng] = inputs.tsbd.split(',').map(x => parseFloat(x.trim()));
            distance = calculateDistance(tsbdLat, tsbdLng, lat, lng) + ' km';
          }

          data.push({
            'Loáº¡i': type,
            'VÄ© Ä‘á»™ (Latitude)': lat.toFixed(6),
            'Kinh Ä‘á»™ (Longitude)': lng.toFixed(6),
            'Khoáº£ng cÃ¡ch tá»« TSBÄ': distance,
            'Thá»i gian': timestamp
          });
        }
      });

      return data;
    }

    function loadFromFile() {
      document.getElementById('file-input').click();
    }

    function handleFileLoad(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let data = [];
          
          if (file.name.endsWith('.csv')) {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index];
              });
              data.push(row);
            }
          } else if (file.name.endsWith('.xlsx')) {
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            data = XLSX.utils.sheet_to_json(worksheet);
          }

          loadDataToForm(data);
          
        } catch (error) {
          alert('Lá»—i khi Ä‘á»c file: ' + error.message);
        }
      };

      if (file.name.endsWith('.xlsx')) {
        reader.readAsBinaryString(file);
      } else {
        reader.readAsText(file, 'utf-8');
      }
    }

    function loadDataToForm(data) {
      clearAll();
      
      data.forEach(row => {
        const type = row['Loáº¡i'] || row['Type'] || '';
        const lat = row['VÄ© Ä‘á»™ (Latitude)'] || row['Latitude'] || '';
        const lng = row['Kinh Ä‘á»™ (Longitude)'] || row['Longitude'] || '';
        
        if (lat && lng) {
          const coordinates = `${lat}, ${lng}`;
          
          if (type.includes('TSBÄ')) {
            document.getElementById('tsbd').value = coordinates;
          } else if (type.includes('TSSS 1')) {
            document.getElementById('tsss1').value = coordinates;
          } else if (type.includes('TSSS 2')) {
            document.getElementById('tsss2').value = coordinates;
          } else if (type.includes('TSSS 3')) {
            document.getElementById('tsss3').value = coordinates;
          }
        }
      });
      
      updateMarkers();
      alert(`ÄÃ£ táº£i thÃ nh cÃ´ng ${data.length} tá»a Ä‘á»™ tá»« file!`);
    }

    // Screenshot functionality
    let currentScreenshotBlob = null;
    let currentScreenshotFilename = null;

    function takeScreenshot(format = 'png') {
      const hideControls = document.getElementById('hide-controls').checked;
      const addWatermark = document.getElementById('add-watermark').checked;
      
      // Hiá»ƒn thá»‹ loading
      showLoading(true);
      
      // áº¨n controls náº¿u Ä‘Æ°á»£c chá»n
      if (hideControls) {
        document.querySelector('.controls').style.display = 'none';
        document.getElementById('click-info').style.display = 'none';
      }

      // Äá»£i má»™t chÃºt Ä‘á»ƒ UI cáº­p nháº­t
      setTimeout(() => {
        const options = {
          allowTaint: true,
          useCORS: true,
          scale: format === 'hd' ? 2 : 1, // HD = scale 2x
          width: window.innerWidth,
          height: window.innerHeight,
          backgroundColor: '#ffffff',
          logging: false,
          removeContainer: true
        };

        html2canvas(document.body, options).then(canvas => {
          // ThÃªm watermark náº¿u Ä‘Æ°á»£c chá»n
          if (addWatermark) {
            addWatermarkToCanvas(canvas);
          }

          // Convert format
          let mimeType, extension, quality;
          if (format === 'jpg') {
            mimeType = 'image/jpeg';
            extension = 'jpg';
            quality = 0.85;
          } else {
            mimeType = 'image/png';
            extension = 'png';
            quality = 1.0;
          }

          // Táº¡o filename dá»±a trÃªn tá»a Ä‘á»™ TSBÄ
          const tsbdCoords = document.getElementById('tsbd').value.trim();
          if (tsbdCoords) {
            const [lat, lng] = tsbdCoords.split(',').map(x => x.trim());
            currentScreenshotFilename = `BIDV_TSBD_${lat}_${lng}_${new Date().toISOString().slice(0,10)}.${extension}`;
          } else {
            currentScreenshotFilename = `BIDV_Map_${new Date().toISOString().slice(0,10)}.${extension}`;
          }

          // Táº¡o blob vÃ  hiá»ƒn thá»‹ preview
          canvas.toBlob((blob) => {
            currentScreenshotBlob = blob;
            
            // Hiá»ƒn thá»‹ preview
            const url = URL.createObjectURL(blob);
            showPreview(url);
            
            // áº¨n loading
            showLoading(false);

            // Hiá»‡n láº¡i controls
            if (hideControls) {
              document.querySelector('.controls').style.display = 'block';
              document.getElementById('click-info').style.display = 'block';
            }
            
          }, mimeType, quality);

        }).catch(error => {
          console.error('Lá»—i chá»¥p áº£nh:', error);
          
          // áº¨n loading
          showLoading(false);
          
          // Hiá»‡n láº¡i controls náº¿u cÃ³ lá»—i
          if (hideControls) {
            document.querySelector('.controls').style.display = 'block';
            document.getElementById('click-info').style.display = 'block';
          }
          
          showNotification('âŒ Lá»—i khi chá»¥p áº£nh: ' + error.message, 'error');
        });
      }, 300);
    }

    function showLoading(show) {
      const overlay = document.getElementById('loading-overlay');
      overlay.style.display = show ? 'flex' : 'none';
    }

    function showPreview(imageUrl) {
      const preview = document.getElementById('screenshot-preview');
      const image = document.getElementById('preview-image');
      
      image.src = imageUrl;
      preview.style.display = 'block';
    }

    function closePreview() {
      const preview = document.getElementById('screenshot-preview');
      preview.style.display = 'none';
      
      // Cleanup URL
      const image = document.getElementById('preview-image');
      if (image.src) {
        URL.revokeObjectURL(image.src);
      }
    }

    function downloadPreviewImage() {
      if (currentScreenshotBlob && currentScreenshotFilename) {
        const url = URL.createObjectURL(currentScreenshotBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentScreenshotFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification(`âœ… ÄÃ£ táº£i xuá»‘ng: ${currentScreenshotFilename}`);
        closePreview();
      }
    }

    function shareImage() {
      if (navigator.share && currentScreenshotBlob) {
        // Sá»­ dá»¥ng Web Share API náº¿u cÃ³ (mobile)
        const file = new File([currentScreenshotBlob], currentScreenshotFilename, {
          type: currentScreenshotBlob.type
        });
        
        navigator.share({
          title: 'BIDV - Báº£n Ä‘á»“ TSBÄ & TSSS',
          text: 'Báº£n Ä‘á»“ vá»‹ trÃ­ tÃ i sáº£n tá»« BIDV',
          files: [file]
        }).then(() => {
          showNotification('âœ… ÄÃ£ chia sáº» áº£nh!');
        }).catch(err => {
          console.log('Lá»—i chia sáº»:', err);
          copyImageToClipboard();
        });
      } else {
        copyImageToClipboard();
      }
    }

    function copyImageToClipboard() {
      // Copy image to clipboard (modern browsers)
      if (navigator.clipboard && currentScreenshotBlob) {
        navigator.clipboard.write([
          new ClipboardItem({
            [currentScreenshotBlob.type]: currentScreenshotBlob
          })
        ]).then(() => {
          showNotification('âœ… ÄÃ£ copy áº£nh vÃ o clipboard!');
        }).catch(() => {
          // Fallback: tá»± Ä‘á»™ng táº£i xuá»‘ng
          downloadPreviewImage();
        });
      } else {
        // Fallback: tá»± Ä‘á»™ng táº£i xuá»‘ng
        downloadPreviewImage();
      }
    }

    function takeScreenshotHD() {
      takeScreenshot('hd');
    }

    function addWatermarkToCanvas(canvas) {
      const ctx = canvas.getContext('2d');
      
      // ThÃ´ng tin tá»a Ä‘á»™
      const tsbdCoords = document.getElementById('tsbd').value.trim();
      const tsssCoords = [
        document.getElementById('tsss1').value.trim(),
        document.getElementById('tsss2').value.trim(),
        document.getElementById('tsss3').value.trim()
      ].filter(coord => coord);

      // Váº½ watermark chÃ­nh
      const watermarkText = 'BIDV - Báº£n Ä‘á»“ TSBÄ & TSSS';
      const timestamp = new Date().toLocaleString('vi-VN');
      
      // Thiáº¿t láº­p font
      const scale = canvas.width / 1920; // Responsive font scaling
      const fontSize = Math.max(16, 20 * scale);
      const smallFontSize = Math.max(12, 14 * scale);
      
      ctx.font = `bold ${fontSize}px Arial`;
      ctx.textAlign = 'left';
      
      // TÃ­nh toÃ¡n vá»‹ trÃ­ watermark
      const padding = 20 * scale;
      const lineHeight = fontSize * 1.3;
      
      // Váº½ background cho watermark
      const watermarkLines = [watermarkText, timestamp];
      
      if (tsbdCoords) {
        watermarkLines.push(`TSBÄ: ${tsbdCoords}`);
      }
      
      tsssCoords.forEach((coord, index) => {
        if (coord) {
          const distance = document.getElementById(`dist-tsss${index + 1}`).textContent;
          watermarkLines.push(`TSSS ${index + 1}: ${coord} ${distance}`);
        }
      });

      // TÃ­nh chiá»u rá»™ng tá»‘i Ä‘a
      ctx.font = `bold ${fontSize}px Arial`;
      let maxWidth = ctx.measureText(watermarkText).width;
      
      ctx.font = `${smallFontSize}px Arial`;
      watermarkLines.slice(1).forEach(line => {
        maxWidth = Math.max(maxWidth, ctx.measureText(line).width);
      });

      const bgHeight = watermarkLines.length * lineHeight + padding;
      const bgWidth = maxWidth + padding * 2;
      
      // Váº½ background vá»›i Ä‘á»™ trong suá»‘t
      ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
      ctx.fillRect(
        canvas.width - bgWidth - padding,
        canvas.height - bgHeight - padding,
        bgWidth + padding,
        bgHeight
      );
      
      // Váº½ border
      ctx.strokeStyle = '#007d78';
      ctx.lineWidth = 2;
      ctx.strokeRect(
        canvas.width - bgWidth - padding,
        canvas.height - bgHeight - padding,
        bgWidth + padding,
        bgHeight
      );

      // Váº½ text
      let yPos = canvas.height - bgHeight - padding + lineHeight;
      
      // Title
      ctx.font = `bold ${fontSize}px Arial`;
      ctx.fillStyle = '#007d78';
      ctx.fillText(
        watermarkText,
        canvas.width - bgWidth - padding/2,
        yPos
      );
      
      yPos += lineHeight;
      
      // Details
      ctx.font = `${smallFontSize}px Arial`;
      ctx.fillStyle = '#333';
      
      watermarkLines.slice(1).forEach(line => {
        ctx.fillText(
          line,
          canvas.width - bgWidth - padding/2,
          yPos
        );
        yPos += smallFontSize * 1.2;
      });

      // ThÃªm logo/icon náº¿u cÃ³
      addLogoToCanvas(ctx, canvas, scale);
    }

    function addLogoToCanvas(ctx, canvas, scale) {
      // Váº½ má»™t logo BIDV Ä‘Æ¡n giáº£n
      const logoSize = 40 * scale;
      const logoX = canvas.width - logoSize * 6;
      const logoY = canvas.height - logoSize * 1.5;
      
      // Váº½ hÃ¬nh trÃ²n cho logo
      ctx.beginPath();
      ctx.arc(logoX, logoY, logoSize/2, 0, 2 * Math.PI);
      ctx.fillStyle = '#007d78';
      ctx.fill();
      
      // Váº½ text "BIDV"
      ctx.font = `bold ${logoSize/3}px Arial`;
      ctx.fillStyle = 'white';
      ctx.textAlign = 'center';
      ctx.fillText('BIDV', logoX, logoY + logoSize/8);
    }

    function showNotification(message, type = 'success') {
      // Táº¡o notification element
      const notification = document.createElement('div');
      
      let bgColor;
      switch(type) {
        case 'error': bgColor = '#f44336'; break;
        case 'info': bgColor = '#2196f3'; break;
        default: bgColor = '#4caf50';
      }
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: ${bgColor};
        color: white;
        padding: 12px 20px;
        border-radius: 5px;
        font-weight: bold;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
        font-size: 14px;
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Tá»± Ä‘á»™ng xÃ³a sau 4 giÃ¢y cho info, 3 giÃ¢y cho khÃ¡c
      const timeout = type === 'info' ? 4000 : 3000;
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, timeout);
    }

    // ThÃªm CSS animation cho notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    ['tsbd', 'tsss1', 'tsss2', 'tsss3'].forEach(id => {
      document.getElementById(id).addEventListener('focus', () => {
        currentInputMode = id;
        updateInputModeDisplay();
      });
      document.getElementById(id).addEventListener('input', updateMarkers);
    });

    // Load My Maps URL tá»« localStorage
    document.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('bidv-my-maps-url');
      if (savedUrl) {
        document.getElementById('my-maps-info').style.display = 'block';
        document.getElementById('my-maps-link').href = savedUrl;
        document.getElementById('my-maps-link').textContent = 'Xem My Map â†’';
      }
    });
  </script>

  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&callback=initMap&language=vi&region=VN"></script>
</body>
</html>