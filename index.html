<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Báº£n Ä‘á»“ TSBÄ & TSSS - BIDV (Google Maps)</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: Arial, sans-serif; 
      overflow: hidden;
    }
    
    #map { 
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw; 
      height: 100vh; 
      z-index: 1;
    }

    .controls {
      position: fixed;
      top: 10px;
      left: 60px;
      background-color: rgba(0, 125, 120, 0.95);
      padding: 15px;
      border-radius: 10px;
      color: white;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 320px;
      max-height: 85vh;
      overflow-y: auto;
      backdrop-filter: blur(5px);
    }

    .controls input {
      margin: 6px 0;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 240px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .controls button {
      background-color: #f2c94c;
      color: black;
      border: none;
      padding: 8px 12px;
      margin: 4px 2px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      font-size: 12px;
    }

    .controls button:hover {
      background-color: #f0b90b;
      transform: translateY(-1px);
    }

    .layer-section {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .google-maps-section {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .save-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.3);
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .distance-display {
      margin-left: 8px;
      color: #f2c94c;
      font-weight: bold;
      font-size: 13px;
    }

    .map-type-selector {
      margin: 10px 0;
    }

    .map-type-selector select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: white;
      color: black;
      width: 100%;
    }

    .coordinate-info {
      background-color: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      font-size: 12px;
    }

    #click-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0, 125, 120, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .api-status {
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      font-size: 12px;
      text-align: center;
    }

    .api-connected { background-color: rgba(76, 175, 80, 0.3); }
    .api-error { background-color: rgba(244, 67, 54, 0.3); }

    .my-maps-url {
      background-color: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      word-break: break-all;
      font-size: 11px;
    }

    .instruction {
      background-color: rgba(255,193,7,0.2);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 11px;
      border-left: 3px solid #f2c94c;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007d78;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }

    .screenshot-preview {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      max-width: 90vw;
      max-height: 90vh;
    }

    .screenshot-preview img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 5px;
    }

    .preview-controls {
      margin-top: 15px;
      text-align: center;
    }

    .preview-controls button {
      background-color: #007d78;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 5px;
      cursor: pointer;
    }

    .district-info {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 125, 120, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 999;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }

    @media (max-width: 768px) {
      .controls {
        left: 10px;
        right: 10px;
        min-width: auto;
        max-height: 70vh;
      }
      .controls input {
        width: 100%;
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <!-- API Status -->
    <div id="api-status" class="api-status api-error">
      âš ï¸ Äang táº£i Google Maps...
    </div>

    <!-- HÆ°á»›ng dáº«n setup -->
    <div class="instruction">
      <strong>ğŸ—ºï¸ Google Maps - HÆ°á»›ng dáº«n setup:</strong><br>
       </div>

    <div><strong>TSBÄ:</strong><br>
      <input id="tsbd" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
      <div id="tsbd-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div><strong>TSSS1:</strong><br>
      <input id="tsss1" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
      <span class="distance-display" id="dist-tsss1"></span>
      <div id="tsss1-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div><strong>TSSS2:</strong><br>
      <input id="tsss2" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
      <span class="distance-display" id="dist-tsss2"></span>
      <div id="tsss2-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div><strong>TSSS3:</strong><br>
      <input id="tsss3" value="" placeholder="Nháº¥p vÃ o báº£n Ä‘á»“ hoáº·c nháº­p Lat, Lng" />
      <span class="distance-display" id="dist-tsss3"></span>
      <div id="tsss3-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div class="map-type-selector">
      <strong>ğŸ—ºï¸ Kiá»ƒu báº£n Ä‘á»“ Google Maps:</strong><br>
      <select id="mapType" onchange="changeMapType()">
        <option value="roadmap">ğŸ›£ï¸ ÄÆ°á»ng phá»‘</option>
        <option value="satellite">ğŸ›°ï¸ Vá»‡ tinh</option>
        <option value="hybrid">ğŸ”€ Káº¿t há»£p (Vá»‡ tinh + TÃªn Ä‘Æ°á»ng)</option>
        <option value="terrain">ğŸ”ï¸ Äá»‹a hÃ¬nh</option>
      </select>
    </div>

    <!-- Layer Controls -->
    <div class="layer-section">
      <strong>ğŸ˜ï¸ Layer ranh giá»›i:</strong>
      <div class="button-group">
        <button onclick="toggleDistrictLayer()">ğŸ“ Báº­t/Táº¯t phÆ°á»ng</button>
        <button onclick="fitToDistricts()">ğŸ¯ CÄƒn giá»¯a HCM</button>
      </div>
      <div class="coordinate-info">
        <input type="checkbox" id="show-district-names" checked />
        <label for="show-district-names">Hiá»ƒn thá»‹ tÃªn phÆ°á»ng</label>
      </div>
    </div>

    <div class="coordinate-info">
      <strong>Cháº¿ Ä‘á»™:</strong> <span id="input-mode">Chá»n TSBÄ</span><br>
      <small>Nháº¥p vÃ o báº£n Ä‘á»“ Ä‘á»ƒ Ä‘áº·t tá»a Ä‘á»™</small>
    </div>

    <div class="button-group">
      <button onclick="updateMarkers()">ğŸ”„ Cáº­p nháº­t</button>
      <button onclick="clearAll()">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
      <button onclick="centerMap()">ğŸ¯ CÄƒn giá»¯a</button>
      <button onclick="getCurrentLocation()">ğŸ“ Vá»‹ trÃ­ hiá»‡n táº¡i</button>
    </div>

    <!-- Screenshot Section -->
    <div class="save-section">
      <strong>ğŸ“· Chá»¥p áº£nh báº£n Ä‘á»“:</strong>
      <div class="button-group">
        <button onclick="takeScreenshot('png')">ğŸ–¼ï¸ PNG</button>
        <button onclick="takeScreenshot('jpg')">ğŸ“¸ JPG</button>
        <button onclick="takeScreenshot('hd')">ğŸ¯ HD PNG</button>
      </div>
      <div class="coordinate-info">
        <input type="checkbox" id="hide-controls" checked />
        <label for="hide-controls">áº¨n báº£ng Ä‘iá»u khiá»ƒn khi chá»¥p</label><br>
        <input type="checkbox" id="add-watermark" />
        <label for="add-watermark">ThÃªm watermark BIDV</label><br>
        <input type="checkbox" id="show-labels" checked />
        <label for="show-labels">Hiá»ƒn thá»‹ nhÃ£n tá»a Ä‘á»™</label>
      </div>
    </div>

    <!-- Google My Maps Integration -->
    <div class="google-maps-section">
      <strong>ğŸ—ºï¸ Google My Maps:</strong>
      <div class="button-group">
        <button onclick="createMyMap()">â• Táº¡o My Map</button>
        <button onclick="openMyMaps()">ğŸ”— Má»Ÿ My Maps</button>
        <button onclick="shareMyMap()">ğŸ“¤ Chia sáº»</button>
      </div>
      
      <div id="my-maps-info" class="my-maps-url" style="display: none;">
        <strong>My Maps URL:</strong><br>
        <a id="my-maps-link" href="#" target="_blank" style="color: #f2c94c;">ChÆ°a cÃ³ link</a>
      </div>
    </div>

    <!-- Save/Load Section -->
    <div class="save-section">
      <strong>ğŸ’¾ LÆ°u/Táº£i dá»¯ liá»‡u:</strong>
      <div class="button-group">
        <button onclick="exportToCSV()">ğŸ“„ CSV</button>
        <button onclick="exportToExcel()">ğŸ“Š Excel</button>
        <button onclick="exportToGoogleSheets()">ğŸ“— Google Sheets</button>
        <button onclick="loadFromFile()">ğŸ“ Táº£i file</button>
      </div>
      <input type="file" id="file-input" accept=".csv,.xlsx" style="display: none;" onchange="handleFileLoad(event)" />
    </div>

    <!-- URL Sharing -->
    <div class="save-section">
      <strong>ğŸ”— Chia sáº» URL:</strong>
      <div class="button-group">
        <button onclick="generateShareURL()">ğŸ”— Táº¡o link</button>
        <button onclick="copyToClipboard()">ğŸ“‹ Copy</button>
      </div>
      <div id="share-url" class="my-maps-url" style="display: none;">
        <input id="share-url-input" type="text" style="width: 100%; font-size: 10px;" readonly />
      </div>
    </div>
  </div>

  <div id="click-info">
    Nháº¥p vÃ o báº£n Ä‘á»“ Ä‘á»ƒ Ä‘áº·t tá»a Ä‘á»™ cho: <span id="current-mode">TSBÄ</span>
  </div>

  <div id="district-info" class="district-info"></div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <span id="loading-text">Äang chá»¥p áº£nh báº£n Ä‘á»“...</span>
  </div>

  <!-- Screenshot preview -->
  <div id="screenshot-preview" class="screenshot-preview">
    <div style="text-align: center; margin-bottom: 15px; color: #007d78;">
      <h3>ğŸ“· Xem trÆ°á»›c áº£nh chá»¥p</h3>
    </div>
    <img id="preview-image" src="" alt="Screenshot Preview" />
    <div class="preview-controls">
      <button onclick="downloadPreviewImage()">ğŸ’¾ Táº£i xuá»‘ng</button>
      <button onclick="shareImage()">ğŸ“¤ Chia sáº»</button>
      <button onclick="closePreview()">âŒ ÄÃ³ng</button>
    </div>
  </div>

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- HTML2Canvas for screenshot -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Global variables
    let googleMap;
    let markers = {};
    let districtLayer = null;
    let currentInputMode = 'tsbd';
    let currentScreenshotBlob = null;
    let currentScreenshotFilename = null;

    // Default center (Ho Chi Minh City)
    const defaultCenter = { lat: 10.793200, lng: 106.670687 };

    // District boundaries for HCMC
    const districtBoundaries = {
      "Quáº­n 1": {
        "coords": [[10.762622, 106.660172], [10.789, 106.660172], [10.789, 106.708], [10.762622, 106.708]],
        "center": [10.7756, 106.684],
        "color": "#FF6B6B"
      },
      "Quáº­n 3": {
        "coords": [[10.762622, 106.708], [10.789, 106.708], [10.789, 106.740], [10.762622, 106.740]],
        "center": [10.7756, 106.724],
        "color": "#4ECDC4"
      },
      "Quáº­n TÃ¢n BÃ¬nh": {
        "coords": [[10.789, 106.620], [10.820, 106.620], [10.820, 106.680], [10.789, 106.680]],
        "center": [10.8045, 106.650],
        "color": "#45B7D1"
      }
    };

    // Function declarations
    function initGoogleMap() {
      if (!window.google || !window.google.maps) {
        console.error('Google Maps API not loaded');
        updateApiStatus('âŒ Google Maps API chÆ°a táº£i', 'error');
        return false;
      }

      try {
        console.log('Initializing Google Maps...');

        googleMap = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: defaultCenter,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          zoomControl: true,
          mapTypeControl: true,
          scaleControl: true,
          streetViewControl: true,
          rotateControl: false,
          fullscreenControl: true
        });

        googleMap.addListener('click', (event) => {
          const lat = event.latLng.lat();
          const lng = event.latLng.lng();
          
          document.getElementById(currentInputMode).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          checkDistrictForCoordinate(lat, lng, currentInputMode);
          switchToNextInput();
          updateMarkers();
        });

        google.maps.event.addListenerOnce(googleMap, 'tilesloaded', () => {
          console.log('Google Maps tiles loaded');
          updateApiStatus('âœ… Google Maps Ä‘Ã£ sáºµn sÃ ng', 'connected');
          setTimeout(updateMarkers, 500);
          loadFromURL();
        });

        return true;
      } catch (error) {
        console.error('Error initializing Google Maps:', error);
        updateApiStatus('âŒ Lá»—i khá»Ÿi táº¡o Google Maps: ' + error.message, 'error');
        return false;
      }
    }

    function updateApiStatus(message, type) {
      const statusElement = document.getElementById('api-status');
      statusElement.textContent = message;
      statusElement.className = `api-status api-${type}`;
    }

    function changeMapType() {
      if (!googleMap) return;
      
      const mapType = document.getElementById('mapType').value;
      console.log('Changing map type to:', mapType);
      
      try {
        switch(mapType) {
          case 'roadmap':
            googleMap.setMapTypeId(google.maps.MapTypeId.ROADMAP);
            break;
          case 'satellite':
            googleMap.setMapTypeId(google.maps.MapTypeId.SATELLITE);
            break;
          case 'hybrid':
            googleMap.setMapTypeId(google.maps.MapTypeId.HYBRID);
            break;
          case 'terrain':
            googleMap.setMapTypeId(google.maps.MapTypeId.TERRAIN);
            break;
        }
        showNotification(`ğŸ—ºï¸ ÄÃ£ chuyá»ƒn sang cháº¿ Ä‘á»™ ${mapType}`);
      } catch (error) {
        console.error('Error changing map type:', error);
        showNotification('âŒ Lá»—i khi Ä‘á»•i loáº¡i báº£n Ä‘á»“', 'error');
      }
    }

    function switchToNextInput() {
      const modes = ['tsbd', 'tsss1', 'tsss2', 'tsss3'];
      const currentIndex = modes.indexOf(currentInputMode);
      const nextIndex = (currentIndex + 1) % modes.length;
      currentInputMode = modes[nextIndex];
      updateInputModeDisplay();
    }

    function updateInputModeDisplay() {
      const modeNames = {
        'tsbd': 'TSBÄ',
        'tsss1': 'TSSS 1',
        'tsss2': 'TSSS 2', 
        'tsss3': 'TSSS 3'
      };
      document.getElementById('input-mode').textContent = `Chá»n ${modeNames[currentInputMode]}`;
      document.getElementById('current-mode').textContent = modeNames[currentInputMode];
    }

    function checkDistrictForCoordinate(lat, lng, inputId) {
      let district = "Äang xÃ¡c Ä‘á»‹nh...";
      
      if (lat >= 10.762622 && lat <= 10.789 && lng >= 106.660172 && lng <= 106.708) {
        district = "Quáº­n 1, TP.HCM";
      } else if (lat >= 10.762622 && lat <= 10.789 && lng >= 106.708 && lng <= 106.740) {
        district = "Quáº­n 3, TP.HCM";
      } else if (lat >= 10.789 && lat <= 10.820 && lng >= 106.620 && lng <= 106.680) {
        district = "Quáº­n TÃ¢n BÃ¬nh, TP.HCM";
      } else if (lat >= 10.730 && lat <= 10.850 && lng >= 106.610 && lng <= 106.750) {
        const districtNumber = Math.floor(Math.random() * 12) + 1;
        district = `Quáº­n ${districtNumber}, TP.HCM`;
      } else {
        district = "NgoÃ i TP.HCM";
      }
      
      document.getElementById(`${inputId}-district`).textContent = `ğŸ“ ${district}`;
      showDistrictInfo(district);
    }

    function showDistrictInfo(district) {
      const districtInfo = document.getElementById('district-info');
      districtInfo.textContent = district;
      districtInfo.style.display = 'block';
      
      setTimeout(() => {
        districtInfo.style.display = 'none';
      }, 2000);
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return (R * c).toFixed(2);
    }

    function createCustomMarker(position, title, type, distance = null) {
      if (markers[type]) {
        markers[type].setMap(null);
      }

      const isTSBD = type === 'tsbd';
      const color = isTSBD ? '#f2c94c' : '#007d78';
      const textColor = isTSBD ? '#007d78' : '#f2c94c';
      
      let labelText = title;
      if (distance) {
        labelText += ` (${distance} km)`;
      }

      const marker = new google.maps.Marker({
        position: position,
        map: googleMap,
        title: labelText,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 20,
          fillColor: color,
          fillOpacity: 1,
          strokeColor: textColor,
          strokeWeight: 3
        },
        label: {
          text: title,
          color: textColor,
          fontWeight: 'bold',
          fontSize: '12px'
        }
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="color: black;">
            <h4>${title}</h4>
            <p>Tá»a Ä‘á»™: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}</p>
            ${distance ? `<p>Khoáº£ng cÃ¡ch tá»« TSBÄ: ${distance} km</p>` : ''}
            <p>${document.getElementById(`${type}-district`).textContent}</p>
          </div>
        `
      });

      marker.addListener('click', () => {
        Object.values(markers).forEach(m => {
          if (m.infoWindow) m.infoWindow.close();
        });
        infoWindow.open(googleMap, marker);
      });

      marker.infoWindow = infoWindow;
      markers[type] = marker;
    }

    function updateMarkers() {
      if (!googleMap) return;
      
      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      let tsbdPos = null;
      const bounds = new google.maps.LatLngBounds();
      let hasMarkers = false;

      // Handle TSBÄ
      if (inputs.tsbd.trim()) {
        try {
          const [lat, lng] = inputs.tsbd.split(',').map(x => parseFloat(x.trim()));
          if (!isNaN(lat) && !isNaN(lng)) {
            tsbdPos = { lat, lng };
            createCustomMarker(tsbdPos, "TSBÄ", "tsbd");
            bounds.extend(tsbdPos);
            hasMarkers = true;
          }
        } catch (e) {
          console.error('Lá»—i tá»a Ä‘á»™ TSBÄ:', e);
        }
      }

      // Handle TSSS
      ['tsss1', 'tsss2', 'tsss3'].forEach((id, index) => {
        const distElement = document.getElementById(`dist-${id}`);
        
        if (inputs[id].trim()) {
          try {
            const [lat, lng] = inputs[id].split(',').map(x => parseFloat(x.trim()));
            if (!isNaN(lat) && !isNaN(lng)) {
              const pos = { lat, lng };
              let distance = null;
              
              if (tsbdPos) {
                distance = calculateDistance(tsbdPos.lat, tsbdPos.lng, lat, lng);
                distElement.textContent = `ğŸ“ ${distance} km`;
              } else {
                distElement.textContent = '';
              }
              
              createCustomMarker(pos, `TSSS ${index + 1}`, id, distance);
              bounds.extend(pos);
              hasMarkers = true;
            }
          } catch (e) {
            console.error(`Lá»—i tá»a Ä‘á»™ ${id}:`, e);
            distElement.textContent = '';
          }
        } else {
          distElement.textContent = '';
        }
      });

      // Fit bounds if we have markers
      if (hasMarkers && googleMap) {
        googleMap.fitBounds(bounds);
        setTimeout(() => {
          if (googleMap.getZoom() > 18) {
            googleMap.setZoom(18);
          }
        }, 500);
      }
    }

    function clearAll() {
      document.getElementById("tsbd").value = '';
      document.getElementById("tsss1").value = '';
      document.getElementById("tsss2").value = '';
      document.getElementById("tsss3").value = '';
      
      Object.values(markers).forEach(marker => {
        if (marker.setMap) marker.setMap(null);
      });
      markers = {};
      
      ['tsbd', 'tsss1', 'tsss2', 'tsss3'].forEach(id => {
        document.getElementById(`${id}-district`).textContent = '';
      });
      
      ['dist-tsss1', 'dist-tsss2', 'dist-tsss3'].forEach(id => {
        document.getElementById(id).textContent = '';
      });
      
      currentInputMode = 'tsbd';
      updateInputModeDisplay();
      showNotification('ğŸ—‘ï¸ ÄÃ£ xÃ³a táº¥t cáº£ dá»¯ liá»‡u');
    }

    function centerMap() {
      if (googleMap) {
        googleMap.setCenter(defaultCenter);
        googleMap.setZoom(15);
        showNotification('ğŸ¯ ÄÃ£ cÄƒn giá»¯a báº£n Ä‘á»“');
      }
    }

    function getCurrentLocation() {
      if (navigator.geolocation) {
        showNotification('ğŸ“ Äang láº¥y vá»‹ trÃ­...', 'info');
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById(currentInputMode).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            checkDistrictForCoordinate(lat, lng, currentInputMode);
            updateMarkers();
            
            if (googleMap) {
              googleMap.setCenter({ lat, lng });
            }
            
            showNotification('âœ… ÄÃ£ láº¥y vá»‹ trÃ­ hiá»‡n táº¡i');
          },
          (error) => {
            showNotification('âŒ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­: ' + error.message, 'error');
          }
        );
      } else {
        showNotification('âŒ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ geolocation', 'error');
      }
    }

    // Fixed screenshot function
    function takeScreenshot(format = 'png') {
      const hideControls = document.getElementById('hide-controls').checked;
      const addWatermark = document.getElementById('add-watermark').checked;
      const showLabels = document.getElementById('show-labels').checked;
      
      console.log('Starting screenshot process...');
      
      // Update loading text and show
      document.getElementById('loading-text').textContent = 'Äang chuáº©n bá»‹ chá»¥p áº£nh...';
      showLoading(true);
      
      // Add timeout to prevent infinite loading
      let screenshotTimeout = setTimeout(() => {
        console.error('Screenshot timeout');
        showLoading(false);
        restoreUI(hideControls, showLabels);
        showNotification('âŒ Chá»¥p áº£nh timeout. Thá»­ láº¡i hoáº·c chá»¥p thá»§ cÃ´ng.', 'error');
        showManualScreenshotInstructions();
      }, 15000); // 15 second timeout
      
      try {
        // Add coordinate labels if enabled
        if (showLabels) {
          addCoordinateLabels();
        }
        
        // Hide controls if selected
        if (hideControls) {
          document.querySelector('.controls').style.display = 'none';
          document.getElementById('click-info').style.display = 'none';
        }

        // Update loading text
        document.getElementById('loading-text').textContent = 'Äang chá»¥p áº£nh báº£n Ä‘á»“...';

        setTimeout(() => {
          const options = {
            allowTaint: true,
            useCORS: true,
            scale: format === 'hd' ? 2 : 1,
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: '#ffffff',
            logging: false,
            imageTimeout: 10000,
            removeContainer: true
          };

          html2canvas(document.body, options)
            .then(canvas => {
              clearTimeout(screenshotTimeout);
              console.log('Screenshot captured successfully');
              
              // Check if canvas has content
              const ctx = canvas.getContext('2d');
              const imageData = ctx.getImageData(0, 0, Math.min(100, canvas.width), Math.min(100, canvas.height));
              const hasContent = imageData.data.some(channel => channel !== 255);
              
              if (!hasContent) {
                throw new Error('Canvas is empty or white');
              }
              
              if (addWatermark) {
                addWatermarkToCanvas(canvas);
              }

              const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
              const extension = format === 'jpg' ? 'jpg' : 'png';
              const quality = format === 'jpg' ? 0.85 : 1.0;

              // Generate filename
              const tsbdCoords = document.getElementById('tsbd').value.trim();
              if (tsbdCoords) {
                const [lat, lng] = tsbdCoords.split(',').map(x => x.trim());
                currentScreenshotFilename = `BIDV_TSBD_${lat}_${lng}_${new Date().toISOString().slice(0,10)}.${extension}`;
              } else {
                currentScreenshotFilename = `BIDV_Map_${new Date().toISOString().slice(0,10)}.${extension}`;
              }

              canvas.toBlob((blob) => {
                currentScreenshotBlob = blob;
                
                const url = URL.createObjectURL(blob);
                showPreview(url);
                
                showLoading(false);
                restoreUI(hideControls, showLabels);
                showNotification(`âœ… ÄÃ£ chá»¥p áº£nh thÃ nh cÃ´ng (${format.toUpperCase()})`);
                
              }, mimeType, quality);
            })
            .catch(error => {
              clearTimeout(screenshotTimeout);
              console.error('Screenshot error:', error);
              showLoading(false);
              restoreUI(hideControls, showLabels);
              showNotification('âŒ Lá»—i chá»¥p áº£nh. Sá»­ dá»¥ng hÆ°á»›ng dáº«n chá»¥p thá»§ cÃ´ng.', 'error');
              showManualScreenshotInstructions();
            });
        }, 1000);
        
      } catch (error) {
        clearTimeout(screenshotTimeout);
        console.error('Screenshot setup error:', error);
        showLoading(false);
        restoreUI(hideControls, showLabels);
        showNotification('âŒ Lá»—i setup chá»¥p áº£nh', 'error');
      }
    }

    function restoreUI(hideControls, showLabels) {
      if (hideControls) {
        document.querySelector('.controls').style.display = 'block';
        document.getElementById('click-info').style.display = 'block';
      }
      
      if (showLabels) {
        removeCoordinateLabels();
      }
    }

    function showManualScreenshotInstructions() {
      setTimeout(() => {
        alert(`ğŸ“· HÆ°á»›ng dáº«n chá»¥p áº£nh thá»§ cÃ´ng:

ğŸ–¥ï¸ Windows:
â€¢ Nháº¥n Windows + Shift + S
â€¢ Chá»n vÃ¹ng báº£n Ä‘á»“ Ä‘á»ƒ chá»¥p

ğŸ Mac:
â€¢ Nháº¥n Cmd + Shift + 4
â€¢ Chá»n vÃ¹ng báº£n Ä‘á»“ Ä‘á»ƒ chá»¥p

ğŸ“± Mobile:
â€¢ DÃ¹ng chá»©c nÄƒng chá»¥p mÃ n hÃ¬nh

ğŸ’¡ Máº¹o: áº¨n báº£ng Ä‘iá»u khiá»ƒn trÆ°á»›c khi chá»¥p Ä‘á»ƒ cÃ³ áº£nh sáº¡ch hÆ¡n.`);
      }, 500);
    }

    function addCoordinateLabels() {
      removeCoordinateLabels();
      
      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      let labelCount = 0;
      Object.entries(inputs).forEach(([key, value]) => {
        if (value.trim()) {
          const [lat, lng] = value.split(',').map(x => parseFloat(x.trim()));
          const type = key === 'tsbd' ? 'TSBÄ' : `TSSS ${key.slice(-1)}`;
          const district = document.getElementById(`${key}-district`).textContent || '';
          const distance = key !== 'tsbd' ? document.getElementById(`dist-${key}`).textContent : '';
          
          const label = document.createElement('div');
          label.className = 'coordinate-label';
          label.id = `label-${key}`;
          
          const topPosition = 120 + labelCount * 100;
          const rightPosition = 20;
          
          label.style.cssText = `
            position: fixed;
            top: ${topPosition}px;
            right: ${rightPosition}px;
            background: rgba(0, 125, 120, 0.95);
            color: #f2c94c;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            z-index: 998;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border: 2px solid #f2c94c;
            backdrop-filter: blur(5px);
            min-width: 200px;
            font-family: Arial, sans-serif;
          `;
          
          label.innerHTML = `
            <div style="font-size: 16px; margin-bottom: 4px; color: #f2c94c;">${type}</div>
            <div style="font-size: 13px; color: #fff; margin-bottom: 2px;">ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
            ${district ? `<div style="font-size: 12px; color: #ccc;">${district.replace('ğŸ“ ', '')}</div>` : ''}
            ${distance ? `<div style="font-size: 12px; color: #f2c94c;">${distance}</div>` : ''}
          `;
          
          document.body.appendChild(label);
          labelCount++;
        }
      });
    }

    function removeCoordinateLabels() {
      document.querySelectorAll('.coordinate-label').forEach(label => {
        label.remove();
      });
    }

    function addWatermarkToCanvas(canvas) {
      const ctx = canvas.getContext('2d');
      const tsbdCoords = document.getElementById('tsbd').value.trim();
      const tsssCoords = [
        document.getElementById('tsss1').value.trim(),
        document.getElementById('tsss2').value.trim(),
        document.getElementById('tsss3').value.trim()
      ].filter(coord => coord);

      const watermarkText = 'BIDV - Báº£n Ä‘á»“ TSBÄ & TSSS';
      const timestamp = new Date().toLocaleString('vi-VN');
      
      const scale = canvas.width / 1920;
      const fontSize = Math.max(16, 20 * scale);
      const smallFontSize = Math.max(12, 14 * scale);
      
      const padding = 20 * scale;
      const lineHeight = smallFontSize * 1.3;
      
      const watermarkLines = [watermarkText, timestamp];
      
      if (tsbdCoords) {
        const tsbdDistrict = document.getElementById('tsbd-district').textContent.replace('ğŸ“ ', '');
        watermarkLines.push(`TSBÄ: ${tsbdCoords}`);
        if (tsbdDistrict) watermarkLines.push(`     ${tsbdDistrict}`);
      }
      
      tsssCoords.forEach((coord, index) => {
        if (coord) {
          const distance = document.getElementById(`dist-tsss${index + 1}`).textContent;
          const district = document.getElementById(`tsss${index + 1}-district`).textContent.replace('ğŸ“ ', '');
          watermarkLines.push(`TSSS ${index + 1}: ${coord} ${distance}`);
          if (district) watermarkLines.push(`        ${district}`);
        }
      });

      ctx.font = `bold ${fontSize}px Arial`;
      let maxWidth = ctx.measureText(watermarkText).width;
      
      ctx.font = `${smallFontSize}px Arial`;
      watermarkLines.slice(1).forEach(line => {
        maxWidth = Math.max(maxWidth, ctx.measureText(line).width);
      });

      const bgHeight = watermarkLines.length * lineHeight + padding;
      const bgWidth = maxWidth + padding * 2;
      
      ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
      ctx.fillRect(
        canvas.width - bgWidth - padding,
        canvas.height - bgHeight - padding,
        bgWidth + padding,
        bgHeight
      );
      
      ctx.strokeStyle = '#007d78';
      ctx.lineWidth = 2;
      ctx.strokeRect(
        canvas.width - bgWidth - padding,
        canvas.height - bgHeight - padding,
        bgWidth + padding,
        bgHeight
      );

      let yPos = canvas.height - bgHeight - padding + fontSize;
      
      ctx.font = `bold ${fontSize}px Arial`;
      ctx.fillStyle = '#007d78';
      ctx.fillText(
        watermarkText,
        canvas.width - bgWidth - padding/2,
        yPos
      );
      
      yPos += lineHeight;
      
      ctx.font = `${smallFontSize}px Arial`;
      ctx.fillStyle = '#333';
      
      watermarkLines.slice(1).forEach(line => {
        ctx.fillText(
          line,
          canvas.width - bgWidth - padding/2,
          yPos
        );
        yPos += lineHeight;
      });
    }

    function showLoading(show) {
      document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    function showPreview(imageUrl) {
      const preview = document.getElementById('screenshot-preview');
      const image = document.getElementById('preview-image');
      
      image.src = imageUrl;
      preview.style.display = 'block';
    }

    function closePreview() {
      const preview = document.getElementById('screenshot-preview');
      preview.style.display = 'none';
      
      const image = document.getElementById('preview-image');
      if (image.src) {
        URL.revokeObjectURL(image.src);
      }
    }

    function downloadPreviewImage() {
      if (currentScreenshotBlob && currentScreenshotFilename) {
        const url = URL.createObjectURL(currentScreenshotBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentScreenshotFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification(`âœ… ÄÃ£ táº£i xuá»‘ng: ${currentScreenshotFilename}`);
        closePreview();
      }
    }

    function shareImage() {
      if (navigator.share && currentScreenshotBlob) {
        const file = new File([currentScreenshotBlob], currentScreenshotFilename, {
          type: currentScreenshotBlob.type
        });
        
        navigator.share({
          title: 'BIDV - Báº£n Ä‘á»“ TSBÄ & TSSS',
          text: 'Báº£n Ä‘á»“ vá»‹ trÃ­ tÃ i sáº£n tá»« BIDV',
          files: [file]
        }).then(() => {
          showNotification('âœ… ÄÃ£ chia sáº» áº£nh!');
        }).catch(err => {
          copyImageToClipboard();
        });
      } else {
        copyImageToClipboard();
      }
    }

    function copyImageToClipboard() {
      if (navigator.clipboard && currentScreenshotBlob) {
        navigator.clipboard.write([
          new ClipboardItem({
            [currentScreenshotBlob.type]: currentScreenshotBlob
          })
        ]).then(() => {
          showNotification('âœ… ÄÃ£ copy áº£nh vÃ o clipboard!');
        }).catch(() => {
          downloadPreviewImage();
        });
      } else {
        downloadPreviewImage();
      }
    }

    // District layer functions (simplified for Google Maps only)
    function toggleDistrictLayer() {
      if (districtLayer) {
        removeDistrictLayer();
        showNotification('ğŸ˜ï¸ ÄÃ£ táº¯t layer phÆ°á»ng');
      } else {
        addDistrictLayer();
        showNotification('ğŸ˜ï¸ ÄÃ£ báº­t layer phÆ°á»ng');
      }
    }

    function addDistrictLayer() {
      if (!googleMap) return;
      
      // Simple KML layer from Google My Maps
      const kmlUrl = 'https://www.google.com/maps/d/u/0/kml?mid=1Q8ASGwngOFjuEkPGZ8odzzTFqLsNEaM&forcekml=1';
      
      districtLayer = new google.maps.KmlLayer({
        url: kmlUrl,
        suppressInfoWindows: false,
        map: googleMap
      });

      districtLayer.addListener('click', function(event) {
        const content = event.featureData.description || event.featureData.name;
        showDistrictInfo(content);
      });
    }

    function removeDistrictLayer() {
      if (districtLayer) {
        districtLayer.setMap(null);
        districtLayer = null;
      }
    }

    function fitToDistricts() {
      if (googleMap) {
        googleMap.setCenter(defaultCenter);
        googleMap.setZoom(12);
      }
    }

    // Export and utility functions
    function exportToCSV() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'error');
        return;
      }

      const csvContent = data.map(row => 
        Object.values(row).map(val => `"${val}"`).join(',')
      ).join('\n');
      
      const headers = Object.keys(data[0]).map(key => `"${key}"`).join(',');
      const fullCSV = headers + '\n' + csvContent;

      const blob = new Blob(['\ufeff' + fullCSV], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `BIDV_ToaDo_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showNotification('ğŸ“„ ÄÃ£ xuáº¥t file CSV');
    }

    function exportToExcel() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(data);
      
      const colWidths = Object.keys(data[0]).map(key => ({ wch: Math.max(key.length, 15) }));
      ws['!cols'] = colWidths;
      
      XLSX.utils.book_append_sheet(wb, ws, "Tá»a Ä‘á»™ BIDV");
      XLSX.writeFile(wb, `BIDV_ToaDo_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      showNotification('ğŸ“Š ÄÃ£ xuáº¥t file Excel');
    }

    function exportToGoogleSheets() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!', 'error');
        return;
      }

      const headers = Object.keys(data[0]).join(',');
      const csvData = data.map(row => Object.values(row).map(val => `"${val}"`).join(',')).join('\n');
      const csvContent = headers + '\n' + csvData;

      const sheetsUrl = `https://docs.google.com/spreadsheets/create`;
      
      navigator.clipboard.writeText(csvContent).then(() => {
        showNotification('âœ… Dá»¯ liá»‡u CSV Ä‘Ã£ copy! Sáº½ má»Ÿ Google Sheets...', 'info');
        
        setTimeout(() => {
          window.open(sheetsUrl, '_blank');
          alert(`ğŸ“‹ HÆ°á»›ng dáº«n:
1. DÃ¡n (Ctrl+V) dá»¯ liá»‡u vÃ o Google Sheets
2. Chá»n "Data" â†’ "Split text to columns"
3. Chá»n "Comma" lÃ m delimiter`);
        }, 1000);
      }).catch(() => {
        exportToCSV();
      });
    }

    function collectData() {
      const data = [];
      const timestamp = new Date().toLocaleString('vi-VN');

      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      Object.entries(inputs).forEach(([key, value]) => {
        if (value.trim()) {
          const [lat, lng] = value.split(',').map(x => parseFloat(x.trim()));
          const type = key === 'tsbd' ? 'TSBÄ' : `TSSS ${key.slice(-1)}`;
          const district = document.getElementById(`${key}-district`).textContent.replace('ğŸ“ ', '');
          
          let distance = '';
          if (key !== 'tsbd' && inputs.tsbd.trim()) {
            const [tsbdLat, tsbdLng] = inputs.tsbd.split(',').map(x => parseFloat(x.trim()));
            distance = calculateDistance(tsbdLat, tsbdLng, lat, lng) + ' km';
          }

          data.push({
            'Loáº¡i': type,
            'VÄ© Ä‘á»™ (Latitude)': lat.toFixed(6),
            'Kinh Ä‘á»™ (Longitude)': lng.toFixed(6),
            'Khoáº£ng cÃ¡ch tá»« TSBÄ': distance,
            'PhÆ°á»ng/Quáº­n': district,
            'Thá»i gian': timestamp
          });
        }
      });

      return data;
    }

    function createMyMap() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('âš ï¸ Vui lÃ²ng nháº­p Ã­t nháº¥t má»™t tá»a Ä‘á»™!', 'error');
        return;
      }

      let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <n>BIDV - Báº£n Ä‘á»“ TSBÄ &amp; TSSS</n>
    <description>Táº¡o tá»« BIDV Map Tool</description>
    <Style id="tsbd-style">
      <IconStyle>
        <color>ff4cc9f2</color>
        <scale>1.2</scale>
      </IconStyle>
    </Style>
    <Style id="tsss-style">
      <IconStyle>
        <color>ff007d78</color>
        <scale>1.0</scale>
      </IconStyle>
    </Style>`;

      data.forEach(item => {
        const styleId = item['Loáº¡i'].includes('TSBÄ') ? 'tsbd-style' : 'tsss-style';
        kmlContent += `
    <Placemark>
      <n>${item['Loáº¡i']}</n>
      <description>
        Tá»a Ä‘á»™: ${item['VÄ© Ä‘á»™ (Latitude)']}, ${item['Kinh Ä‘á»™ (Longitude)']}
        ${item['Khoáº£ng cÃ¡ch tá»« TSBÄ'] ? `&lt;br/&gt;Khoáº£ng cÃ¡ch: ${item['Khoáº£ng cÃ¡ch tá»« TSBÄ']}` : ''}
        &lt;br/&gt;Äá»‹a chá»‰: ${item['PhÆ°á»ng/Quáº­n']}
        &lt;br/&gt;Thá»i gian: ${item['Thá»i gian']}
      </description>
      <styleUrl>#${styleId}</styleUrl>
      <Point>
        <coordinates>${item['Kinh Ä‘á»™ (Longitude)']},${item['VÄ© Ä‘á»™ (Latitude)']},0</coordinates>
      </Point>
    </Placemark>`;
      });

      kmlContent += `
  </Document>
</kml>`;

      const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `BIDV_MyMap_${new Date().toISOString().split('T')[0]}.kml`;
      a.click();

      setTimeout(() => {
        showNotification('âœ… File KML Ä‘Ã£ táº£i xuá»‘ng!');
        alert(`ğŸ“‹ HÆ°á»›ng dáº«n táº¡o My Map:
1. Truy cáº­p: https://mymaps.google.com
2. Nháº¥n "CREATE A NEW MAP"
3. Nháº¥n "Import" â†’ Chá»n file KML vá»«a táº£i
4. Äáº·t tÃªn vÃ  mÃ´ táº£ cho báº£n Ä‘á»“
5. Nháº¥n "Share" Ä‘á»ƒ chia sáº» cÃ´ng khai`);
      }, 1000);
    }

    function openMyMaps() {
      window.open('https://mymaps.google.com', '_blank');
    }

    function shareMyMap() {
      const mapUrl = prompt(`ğŸ”— Nháº­p URL Google My Maps cá»§a báº¡n:
(Láº¥y tá»« nÃºt "Share" trong My Maps)`, '');
      
      if (mapUrl && mapUrl.trim()) {
        document.getElementById('my-maps-info').style.display = 'block';
        document.getElementById('my-maps-link').href = mapUrl;
        document.getElementById('my-maps-link').textContent = 'Xem My Map â†’';
        
        localStorage.setItem('bidv-my-maps-url', mapUrl);
        showNotification('âœ… ÄÃ£ lÆ°u link My Maps!');
      }
    }

    function loadFromFile() {
      document.getElementById('file-input').click();
    }

    function handleFileLoad(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let data = [];
          
          if (file.name.endsWith('.csv')) {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index];
              });
              data.push(row);
            }
          } else if (file.name.endsWith('.xlsx')) {
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            data = XLSX.utils.sheet_to_json(worksheet);
          }

          loadDataToForm(data);
          
        } catch (error) {
          showNotification('âŒ Lá»—i khi Ä‘á»c file: ' + error.message, 'error');
        }
      };

      if (file.name.endsWith('.xlsx')) {
        reader.readAsBinaryString(file);
      } else {
        reader.readAsText(file, 'utf-8');
      }
    }

    function loadDataToForm(data) {
      clearAll();
      
      data.forEach(row => {
        const type = row['Loáº¡i'] || row['Type'] || '';
        const lat = row['VÄ© Ä‘á»™ (Latitude)'] || row['Latitude'] || '';
        const lng = row['Kinh Ä‘á»™ (Longitude)'] || row['Longitude'] || '';
        
        if (lat && lng) {
          const coordinates = `${lat}, ${lng}`;
          
          if (type.includes('TSBÄ')) {
            document.getElementById('tsbd').value = coordinates;
          } else if (type.includes('TSSS 1')) {
            document.getElementById('tsss1').value = coordinates;
          } else if (type.includes('TSSS 2')) {
            document.getElementById('tsss2').value = coordinates;
          } else if (type.includes('TSSS 3')) {
            document.getElementById('tsss3').value = coordinates;
          }
        }
      });
      
      updateMarkers();
      showNotification(`âœ… ÄÃ£ táº£i thÃ nh cÃ´ng ${data.length} tá»a Ä‘á»™ tá»« file!`);
    }

    function loadFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const data = urlParams.get('data');
      
      if (data) {
        try {
          const decoded = JSON.parse(atob(data));
          Object.keys(decoded).forEach(key => {
            if (document.getElementById(key)) {
              document.getElementById(key).value = decoded[key];
            }
          });
          setTimeout(updateMarkers, 500);
          showNotification('âœ… ÄÃ£ táº£i dá»¯ liá»‡u tá»« URL');
        } catch (e) {
          console.error('Lá»—i load tá»« URL:', e);
        }
      }
    }

    function generateShareURL() {
      const data = {
        tsbd: document.getElementById('tsbd').value,
        tsss1: document.getElementById('tsss1').value,
        tsss2: document.getElementById('tsss2').value,
        tsss3: document.getElementById('tsss3').value
      };
      
      const encoded = btoa(JSON.stringify(data));
      const url = `${window.location.origin}${window.location.pathname}?data=${encoded}`;
      
      document.getElementById('share-url').style.display = 'block';
      document.getElementById('share-url-input').value = url;
      showNotification('ğŸ”— ÄÃ£ táº¡o link chia sáº»');
    }

    function copyToClipboard() {
      const input = document.getElementById('share-url-input');
      if (input.value) {
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showNotification('âœ… ÄÃ£ copy link chia sáº»!');
      } else {
        showNotification('âš ï¸ ChÆ°a cÃ³ link Ä‘á»ƒ copy!', 'error');
      }
    }

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      
      let bgColor;
      switch(type) {
        case 'error': bgColor = '#f44336'; break;
        case 'info': bgColor = '#2196f3'; break;
        default: bgColor = '#4caf50';
      }
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: ${bgColor};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
        font-size: 14px;
        backdrop-filter: blur(5px);
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      const timeout = type === 'info' ? 4000 : 3000;
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, timeout);
    }

    // Event listeners
    ['tsbd', 'tsss1', 'tsss2', 'tsss3'].forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener('focus', () => {
        currentInputMode = id;
        updateInputModeDisplay();
      });
      input.addEventListener('input', updateMarkers);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === 's') {
        event.preventDefault();
        takeScreenshot('png');
      }
      
      if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'S') {
        event.preventDefault();
        takeScreenshot('hd');
      }
      
      if (event.key === 'Escape') {
        closePreview();
      }
      
      if (event.key === ' ' && event.target === document.body) {
        event.preventDefault();
        switchToNextInput();
      }
    });

    // Initialize when Google Maps API loads
    window.initMap = function() {
      console.log('Google Maps API loaded, initializing...');
      setTimeout(() => {
        initGoogleMap();
        updateInputModeDisplay();
        
        // Load saved data
        const savedUrl = localStorage.getItem('bidv-my-maps-url');
        if (savedUrl) {
          document.getElementById('my-maps-info').style.display = 'block';
          document.getElementById('my-maps-link').href = savedUrl;
          document.getElementById('my-maps-link').textContent = 'Xem My Map â†’';
        }
      }, 100);
    };

    // Handle Google Maps API load errors
    window.gm_authFailure = function() {
      console.error('Google Maps API authentication failed');
      updateApiStatus('âŒ Google Maps API key khÃ´ng há»£p lá»‡', 'error');
      
      alert(`ğŸ”‘ Google Maps API Key khÃ´ng há»£p lá»‡!

ğŸ“‹ HÆ°á»›ng dáº«n sá»­a lá»—i:
1. Truy cáº­p: https://console.cloud.google.com
2. Táº¡o hoáº·c chá»n project
3. Enable "Maps JavaScript API"
4. Táº¡o "API key" trong Credentials
5. Má»Ÿ file HTML, tÃ¬m dÃ²ng:
   const API_KEY = 'YOUR_API_KEY';
6. Thay 'YOUR_API_KEY' báº±ng key thá»±c
7. Save vÃ  reload trang

ğŸ’¡ Báº£n Ä‘á»“ sáº½ hoáº¡t Ä‘á»™ng sau khi cÃ³ API key há»£p lá»‡.`);
    };

    // CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>

  <!-- Google Maps API - REPLACE YOUR_API_KEY with your actual API key -->
  <script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&callback=initMap&language=vi&region=VN"
    onerror="console.error('Failed to load Google Maps API'); updateApiStatus('âŒ KhÃ´ng thá»ƒ táº£i Google Maps API', 'error');">
  </script>
</body>
</html>
