<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B·∫£n ƒë·ªì TSBƒê & TSSS(Enhanced)</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: Arial, sans-serif; 
      overflow: hidden;
    }
    
    #map { 
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw; 
      height: 100vh; 
      z-index: 1;
    }

    .controls {
      position: fixed;
      top: 10px;
      left: 60px;
      background-color: rgba(0, 125, 120, 0.95);
      padding: 15px;
      border-radius: 10px;
      color: white;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 320px;
      max-height: 85vh;
      overflow-y: auto;
      backdrop-filter: blur(5px);
    }

    .controls input {
      margin: 6px 0;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 240px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .controls button {
      background-color: #f2c94c;
      color: black;
      border: none;
      padding: 8px 12px;
      margin: 4px 2px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      font-size: 12px;
    }

    .controls button:hover {
      background-color: #f0b90b;
      transform: translateY(-1px);
    }

    .map-toggle {
      margin: 10px 0;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
      margin-left: 10px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #f2c94c;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .layer-section {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .google-maps-section {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .save-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.3);
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .distance-display {
      margin-left: 8px;
      color: #f2c94c;
      font-weight: bold;
      font-size: 13px;
    }

    .map-type-selector {
      margin: 10px 0;
    }

    .map-type-selector select {
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: white;
      color: black;
    }

    .coordinate-info {
      background-color: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      font-size: 12px;
    }

    #click-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0, 125, 120, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .api-status {
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      font-size: 12px;
      text-align: center;
    }

    .api-connected { background-color: rgba(76, 175, 80, 0.3); }
    .api-error { background-color: rgba(244, 67, 54, 0.3); }

    .my-maps-url {
      background-color: rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 5px;
      margin: 8px 0;
      word-break: break-all;
      font-size: 11px;
    }

    .instruction {
      background-color: rgba(255,193,7,0.2);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 11px;
      border-left: 3px solid #f2c94c;
    }

    /* Custom marker styles for Leaflet */
    .custom-marker {
      background-color: #007d78;
      color: #f2c94c;
      font-weight: bold;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 2px solid #007d78;
      white-space: nowrap;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .custom-marker::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 10px solid #007d78;
    }

    .tsbd-marker {
      background-color: #f2c94c;
      color: #007d78;
      border-color: #f2c94c;
    }

    .tsbd-marker::after {
      border-top-color: #f2c94c;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007d78;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }

    .screenshot-preview {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      max-width: 90vw;
      max-height: 90vh;
    }

    .screenshot-preview img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 5px;
    }

    .preview-controls {
      margin-top: 15px;
      text-align: center;
    }

    .preview-controls button {
      background-color: #007d78;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 5px;
      cursor: pointer;
    }

    .district-info {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 125, 120, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 999;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }

    /* Hide Leaflet attribution */
    .leaflet-control-attribution {
      display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .controls {
        left: 10px;
        right: 10px;
        min-width: auto;
        max-height: 70vh;
      }
      .controls input {
        width: 100%;
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <!-- API Status -->
    <div id="api-status" class="api-status api-connected">
      ‚úÖ B·∫£n ƒë·ªì ƒë√£ s·∫µn s√†ng
    </div>

    <!-- Map Toggle -->
    <div class="map-toggle">
      <strong>üó∫Ô∏è Lo·∫°i b·∫£n ƒë·ªì:</strong>
      <label class="toggle-switch">
        <input type="checkbox" id="map-provider-toggle" onchange="toggleMapProvider()">
        <span class="slider"></span>
      </label>
      <span id="map-provider-label">OpenStreetMap</span>
    </div>

    <!-- H∆∞·ªõng d·∫´n setup -->
    <div class="instruction">
      <strong>üìã H∆∞·ªõng d·∫´n:</strong><br>
      ‚Ä¢ Toggle ƒë·ªÉ chuy·ªÉn ƒë·ªïi Google Maps ‚Üî OSM<br>
      ‚Ä¢ Nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ ƒë·∫∑t t·ªça ƒë·ªô<br>
      ‚Ä¢ B·∫≠t layer ph∆∞·ªùng ƒë·ªÉ xem v·ªã tr√≠ h√†nh ch√≠nh
    </div>

    <div><strong>TSBƒê:</strong><br>
      <input id="tsbd" value="" placeholder="Nh·∫•p v√†o b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng" />
      <div id="tsbd-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div><strong>TSSS1:</strong><br>
      <input id="tsss1" value="" placeholder="Nh·∫•p v√†o b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng" />
      <span class="distance-display" id="dist-tsss1"></span>
      <div id="tsss1-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div><strong>TSSS2:</strong><br>
      <input id="tsss2" value="" placeholder="Nh·∫•p v√†o b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng" />
      <span class="distance-display" id="dist-tsss2"></span>
      <div id="tsss2-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div><strong>TSSS3:</strong><br>
      <input id="tsss3" value="" placeholder="Nh·∫•p v√†o b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p Lat, Lng" />
      <span class="distance-display" id="dist-tsss3"></span>
      <div id="tsss3-district" style="font-size: 11px; color: #f2c94c; margin-top: 2px;"></div>
    </div>

    <div class="map-type-selector" id="google-map-type" style="display: none;">
      <strong>Ki·ªÉu Google Maps:</strong><br>
      <select id="mapType" onchange="changeMapType()">
        <option value="roadmap">ƒê∆∞·ªùng ph·ªë</option>
        <option value="satellite">V·ªá tinh</option>
        <option value="hybrid">K·∫øt h·ª£p</option>
        <option value="terrain">ƒê·ªãa h√¨nh</option>
      </select>
    </div>

    <!-- Layer Controls -->
    <div class="layer-section">
      <strong>üèòÔ∏è Layer ranh gi·ªõi:</strong>
      <div class="button-group">
        <button onclick="toggleDistrictLayer()">üìç B·∫≠t/T·∫Øt ph∆∞·ªùng</button>
        <button onclick="fitToDistricts()">üéØ CƒÉn gi·ªØa HCM</button>
      </div>
      <div class="coordinate-info">
        <input type="checkbox" id="show-district-names" checked />
        <label for="show-district-names">Hi·ªÉn th·ªã t√™n ph∆∞·ªùng</label>
      </div>
    </div>

    <div class="coordinate-info">
      <strong>Ch·∫ø ƒë·ªô:</strong> <span id="input-mode">Ch·ªçn TSBƒê</span><br>
      <small>Nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ ƒë·∫∑t t·ªça ƒë·ªô</small>
    </div>

    <div class="button-group">
      <button onclick="updateMarkers()">üîÑ C·∫≠p nh·∫≠t</button>
      <button onclick="clearAll()">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
      <button onclick="centerMap()">üéØ CƒÉn gi·ªØa</button>
      <button onclick="getCurrentLocation()">üìç V·ªã tr√≠ hi·ªán t·∫°i</button>
    </div>

    <!-- Screenshot Section -->
    <div class="save-section">
      <strong>üì∑ Ch·ª•p ·∫£nh b·∫£n ƒë·ªì:</strong>
      <div class="button-group">
        <button onclick="takeScreenshot('png')">üñºÔ∏è PNG</button>
        <button onclick="takeScreenshot('jpg')">üì∏ JPG</button>
        <button onclick="takeScreenshotHD()">üéØ HD PNG</button>
      </div>
      <div class="coordinate-info">
        <input type="checkbox" id="hide-controls" checked />
        <label for="hide-controls">·∫®n b·∫£ng ƒëi·ªÅu khi·ªÉn khi ch·ª•p</label><br>
        <input type="checkbox" id="add-watermark" />
        <label for="add-watermark">Th√™m watermark BIDV</label><br>
        <input type="checkbox" id="show-labels" checked />
        <label for="show-labels">Hi·ªÉn th·ªã nh√£n t·ªça ƒë·ªô</label>
      </div>
    </div>

    <!-- Google My Maps Integration -->
    <div class="google-maps-section">
      <strong>üó∫Ô∏è Google My Maps:</strong>
      <div class="button-group">
        <button onclick="createMyMap()">‚ûï T·∫°o My Map</button>
        <button onclick="openMyMaps()">üîó M·ªü My Maps</button>
        <button onclick="shareMyMap()">üì§ Chia s·∫ª</button>
      </div>
      
      <div id="my-maps-info" class="my-maps-url" style="display: none;">
        <strong>My Maps URL:</strong><br>
        <a id="my-maps-link" href="#" target="_blank" style="color: #f2c94c;">Ch∆∞a c√≥ link</a>
      </div>
    </div>

    <!-- Save/Load Section -->
    <div class="save-section">
      <strong>üíæ L∆∞u/T·∫£i d·ªØ li·ªáu:</strong>
      <div class="button-group">
        <button onclick="exportToCSV()">üìÑ CSV</button>
        <button onclick="exportToExcel()">üìä Excel</button>
        <button onclick="exportToGoogleSheets()">üìó Google Sheets</button>
        <button onclick="loadFromFile()">üìÅ T·∫£i file</button>
      </div>
      <input type="file" id="file-input" accept=".csv,.xlsx" style="display: none;" onchange="handleFileLoad(event)" />
    </div>

    <!-- URL Sharing -->
    <div class="save-section">
      <strong>üîó Chia s·∫ª URL:</strong>
      <div class="button-group">
        <button onclick="generateShareURL()">üîó T·∫°o link</button>
        <button onclick="copyToClipboard()">üìã Copy</button>
      </div>
      <div id="share-url" class="my-maps-url" style="display: none;">
        <input id="share-url-input" type="text" style="width: 100%; font-size: 10px;" readonly />
      </div>
    </div>
  </div>

  <div id="click-info">
    Nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ ƒë·∫∑t t·ªça ƒë·ªô cho: <span id="current-mode">TSBƒê</span>
  </div>

  <div id="district-info" class="district-info"></div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <span>ƒêang ch·ª•p ·∫£nh b·∫£n ƒë·ªì...</span>
  </div>

  <!-- Screenshot preview -->
  <div id="screenshot-preview" class="screenshot-preview">
    <div style="text-align: center; margin-bottom: 15px; color: #007d78;">
      <h3>üì∑ Xem tr∆∞·ªõc ·∫£nh ch·ª•p</h3>
    </div>
    <img id="preview-image" src="" alt="Screenshot Preview" />
    <div class="preview-controls">
      <button onclick="downloadPreviewImage()">üíæ T·∫£i xu·ªëng</button>
      <button onclick="shareImage()">üì§ Chia s·∫ª</button>
      <button onclick="closePreview()">‚ùå ƒê√≥ng</button>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
          crossorigin=""></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- HTML2Canvas for screenshot -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Global variables
    let leafletMap;
    let googleMap;
    let currentMap = 'leaflet'; // 'leaflet' or 'google'
    let markers = {};
    let leafletMarkers = {};
    let districtLayer = null;
    let currentInputMode = 'tsbd';
    let bounds;
    let currentScreenshotBlob = null;
    let currentScreenshotFilename = null;

    // Default center (Ho Chi Minh City)
    const defaultCenter = [10.793200, 106.670687]; // [lat, lng] for Leaflet
    const defaultCenterGoogle = { lat: 10.793200, lng: 106.670687 }; // {lat, lng} for Google

    // Sample district boundaries for HCMC
    const districtBoundaries = {
      "Qu·∫≠n 1": {
        "coords": [[10.762622, 106.660172], [10.789, 106.660172], [10.789, 106.708], [10.762622, 106.708]],
        "center": [10.7756, 106.684],
        "color": "#FF6B6B"
      },
      "Qu·∫≠n 3": {
        "coords": [[10.762622, 106.708], [10.789, 106.708], [10.789, 106.740], [10.762622, 106.740]],
        "center": [10.7756, 106.724],
        "color": "#4ECDC4"
      },
      "Qu·∫≠n T√¢n B√¨nh": {
        "coords": [[10.789, 106.620], [10.820, 106.620], [10.820, 106.680], [10.789, 106.680]],
        "center": [10.8045, 106.650],
        "color": "#45B7D1"
      }
    };

    // Initialize Leaflet map
    function initLeafletMap() {
      try {
        console.log('Initializing Leaflet map...');
        
        // Remove existing map if any
        if (leafletMap) {
          leafletMap.remove();
        }

        // Create map
        leafletMap = L.map('map', {
          zoomControl: true,
          attributionControl: false
        }).setView(defaultCenter, 15);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(leafletMap);

        // Add click handler
        leafletMap.on('click', function(e) {
          const lat = e.latlng.lat;
          const lng = e.latlng.lng;
          
          console.log('Map clicked:', lat, lng);
          
          document.getElementById(currentInputMode).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          checkDistrictForCoordinate(lat, lng, currentInputMode);
          switchToNextInput();
          updateMarkers();
        });

        console.log('Leaflet map initialized successfully');
        updateApiStatus('‚úÖ OpenStreetMap ƒë√£ s·∫µn s√†ng', 'connected');
        
        // Load saved data if any
        setTimeout(() => {
          loadFromURL();
          const savedTsbd = document.getElementById('tsbd').value;
          if (savedTsbd) {
            updateMarkers();
          }
        }, 500);

      } catch (error) {
        console.error('Error initializing Leaflet map:', error);
        updateApiStatus('‚ùå L·ªói kh·ªüi t·∫°o b·∫£n ƒë·ªì: ' + error.message, 'error');
      }
    }

    // Initialize Google Maps
    function initGoogleMap() {
      if (!window.google || !window.google.maps) {
        updateApiStatus('‚ùå Google Maps API kh√¥ng kh·∫£ d·ª•ng', 'error');
        return false;
      }

      try {
        console.log('Initializing Google map...');

        // Remove Leaflet map
        if (leafletMap) {
          leafletMap.remove();
          leafletMap = null;
        }

        // Clear map container
        document.getElementById('map').innerHTML = '';

        // Create Google map
        googleMap = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: defaultCenterGoogle,
          mapTypeId: 'roadmap'
        });

        // Add click handler
        googleMap.addListener('click', (event) => {
          const lat = event.latLng.lat();
          const lng = event.latLng.lng();
          
          console.log('Google map clicked:', lat, lng);
          
          document.getElementById(currentInputMode).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          checkDistrictForCoordinate(lat, lng, currentInputMode);
          switchToNextInput();
          updateMarkers();
        });

        console.log('Google map initialized successfully');
        updateApiStatus('‚úÖ Google Maps ƒë√£ s·∫µn s√†ng', 'connected');
        currentMap = 'google';

        // Re-add markers if any
        setTimeout(updateMarkers, 300);
        
        return true;
      } catch (error) {
        console.error('Error initializing Google map:', error);
        updateApiStatus('‚ùå L·ªói kh·ªüi t·∫°o Google Maps: ' + error.message, 'error');
        return false;
      }
    }

    // Toggle between map providers
    function toggleMapProvider() {
      const toggle = document.getElementById('map-provider-toggle');
      const label = document.getElementById('map-provider-label');
      const googleControls = document.getElementById('google-map-type');

      if (toggle.checked) {
        // Switch to Google Maps
        if (initGoogleMap()) {
          label.textContent = 'Google Maps';
          googleControls.style.display = 'block';
        } else {
          // Revert toggle if Google Maps failed
          toggle.checked = false;
          label.textContent = 'OpenStreetMap';
          googleControls.style.display = 'none';
          showNotification('‚ùå Kh√¥ng th·ªÉ chuy·ªÉn sang Google Maps. Vui l√≤ng ki·ªÉm tra API key.', 'error');
        }
      } else {
        // Switch to OpenStreetMap
        label.textContent = 'OpenStreetMap';
        googleControls.style.display = 'none';
        currentMap = 'leaflet';
        initLeafletMap();
      }
    }

    // Update API status
    function updateApiStatus(message, type) {
      const statusElement = document.getElementById('api-status');
      statusElement.textContent = message;
      statusElement.className = `api-status api-${type}`;
    }

    // Check which district a coordinate belongs to
    function checkDistrictForCoordinate(lat, lng, inputId) {
      let district = "ƒêang x√°c ƒë·ªãnh...";
      
      // Simple district detection based on coordinate ranges for HCMC
      if (lat >= 10.762622 && lat <= 10.789 && lng >= 106.660172 && lng <= 106.708) {
        district = "Qu·∫≠n 1, TP.HCM";
      } else if (lat >= 10.762622 && lat <= 10.789 && lng >= 106.708 && lng <= 106.740) {
        district = "Qu·∫≠n 3, TP.HCM";
      } else if (lat >= 10.789 && lat <= 10.820 && lng >= 106.620 && lng <= 106.680) {
        district = "Qu·∫≠n T√¢n B√¨nh, TP.HCM";
      } else if (lat >= 10.730 && lat <= 10.850 && lng >= 106.610 && lng <= 106.750) {
        // General HCMC area
        const districtNumber = Math.floor(Math.random() * 12) + 1;
        district = `Qu·∫≠n ${districtNumber}, TP.HCM`;
      } else {
        district = "Ngo√†i TP.HCM";
      }
      
      document.getElementById(`${inputId}-district`).textContent = `üìç ${district}`;
      
      // Show temporary district info
      showDistrictInfo(district);
    }

    function showDistrictInfo(district) {
      const districtInfo = document.getElementById('district-info');
      districtInfo.textContent = district;
      districtInfo.style.display = 'block';
      
      setTimeout(() => {
        districtInfo.style.display = 'none';
      }, 2000);
    }

    // District layer functions
    function toggleDistrictLayer() {
      if (districtLayer) {
        removeDistrictLayer();
        showNotification('üèòÔ∏è ƒê√£ t·∫Øt layer ph∆∞·ªùng');
      } else {
        addDistrictLayer();
        showNotification('üèòÔ∏è ƒê√£ b·∫≠t layer ph∆∞·ªùng');
      }
    }

    function addDistrictLayer() {
      if (currentMap === 'google' && googleMap) {
        // Add Google My Maps KML layer
        const kmlUrl = 'https://www.google.com/maps/d/u/0/kml?mid=1Q8ASGwngOFjuEkPGZ8odzzTFqLsNEaM&forcekml=1';
        
        districtLayer = new google.maps.KmlLayer({
          url: kmlUrl,
          suppressInfoWindows: false,
          map: googleMap
        });

        districtLayer.addListener('click', function(event) {
          const content = event.featureData.description || event.featureData.name;
          showDistrictInfo(content);
        });

      } else if (currentMap === 'leaflet' && leafletMap) {
        // Add boundaries to Leaflet map
        districtLayer = L.layerGroup();

        Object.entries(districtBoundaries).forEach(([name, data]) => {
          const polygon = L.polygon(data.coords, {
            color: data.color,
            fillColor: data.color,
            fillOpacity: 0.3,
            weight: 2
          }).addTo(districtLayer);

          polygon.bindPopup(`<strong>${name}</strong>`);
          
          polygon.on('click', function() {
            showDistrictInfo(name);
          });

          // Add district label if enabled
          if (document.getElementById('show-district-names').checked) {
            L.marker(data.center, {
              icon: L.divIcon({
                className: 'district-label',
                html: `<div style="background: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; border: 1px solid #ccc;">${name}</div>`,
                iconSize: [100, 20],
                iconAnchor: [50, 10]
              })
            }).addTo(districtLayer);
          }
        });

        districtLayer.addTo(leafletMap);
      }
    }

    function removeDistrictLayer() {
      if (districtLayer) {
        if (currentMap === 'google') {
          districtLayer.setMap(null);
        } else {
          leafletMap.removeLayer(districtLayer);
        }
        districtLayer = null;
      }
    }

    function fitToDistricts() {
      if (currentMap === 'google' && googleMap) {
        googleMap.setCenter(defaultCenterGoogle);
        googleMap.setZoom(12);
      } else if (currentMap === 'leaflet' && leafletMap) {
        leafletMap.setView(defaultCenter, 12);
      }
    }

    // Switch input mode
    function switchToNextInput() {
      const modes = ['tsbd', 'tsss1', 'tsss2', 'tsss3'];
      const currentIndex = modes.indexOf(currentInputMode);
      const nextIndex = (currentIndex + 1) % modes.length;
      currentInputMode = modes[nextIndex];
      updateInputModeDisplay();
    }

    function updateInputModeDisplay() {
      const modeNames = {
        'tsbd': 'TSBƒê',
        'tsss1': 'TSSS 1',
        'tsss2': 'TSSS 2', 
        'tsss3': 'TSSS 3'
      };
      document.getElementById('input-mode').textContent = `Ch·ªçn ${modeNames[currentInputMode]}`;
      document.getElementById('current-mode').textContent = modeNames[currentInputMode];
    }

    // Change Google Maps type
    function changeMapType() {
      if (googleMap) {
        const mapType = document.getElementById('mapType').value;
        googleMap.setMapTypeId(mapType);
      }
    }

    // Distance calculation
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return (R * c).toFixed(2);
    }

    // Create custom markers
    function createCustomMarker(position, title, type, distance = null) {
      if (currentMap === 'google' && googleMap) {
        // Google Maps marker
        if (markers[type]) {
          markers[type].setMap(null);
        }

        const isTSBD = type === 'tsbd';
        const color = isTSBD ? '#f2c94c' : '#007d78';
        const textColor = isTSBD ? '#007d78' : '#f2c94c';
        
        let labelText = title;
        if (distance) {
          labelText += ` (${distance} km)`;
        }

        const marker = new google.maps.Marker({
          position: { lat: position.lat, lng: position.lng },
          map: googleMap,
          title: labelText,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 20,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: textColor,
            strokeWeight: 3
          },
          label: {
            text: title,
            color: textColor,
            fontWeight: 'bold',
            fontSize: '12px'
          }
        });

        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="color: black;">
              <h4>${title}</h4>
              <p>T·ªça ƒë·ªô: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}</p>
              ${distance ? `<p>Kho·∫£ng c√°ch t·ª´ TSBƒê: ${distance} km</p>` : ''}
              <p>${document.getElementById(`${type}-district`).textContent}</p>
            </div>
          `
        });

        marker.addListener('click', () => {
          Object.values(markers).forEach(m => {
            if (m.infoWindow) m.infoWindow.close();
          });
          infoWindow.open(googleMap, marker);
        });

        marker.infoWindow = infoWindow;
        markers[type] = marker;

      } else if (currentMap === 'leaflet' && leafletMap) {
        // Leaflet marker
        if (leafletMarkers[type]) {
          leafletMap.removeLayer(leafletMarkers[type]);
        }

        const isTSBD = type === 'tsbd';
        const className = isTSBD ? 'tsbd-marker' : 'custom-marker';
        
        let labelText = title;
        if (distance) {
          labelText += ` (${distance} km)`;
        }

        const customIcon = L.divIcon({
          className: '',
          html: `<div class="${className}">${labelText}</div>`,
          iconSize: [100, 30],
          iconAnchor: [50, 40]
        });

        const marker = L.marker([position.lat, position.lng], { 
          icon: customIcon 
        }).addTo(leafletMap);

        marker.bindPopup(`
          <div>
            <h4>${title}</h4>
            <p>T·ªça ƒë·ªô: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}</p>
            ${distance ? `<p>Kho·∫£ng c√°ch t·ª´ TSBƒê: ${distance} km</p>` : ''}
            <p>${document.getElementById(`${type}-district`).textContent}</p>
          </div>
        `);

        leafletMarkers[type] = marker;
      }
    }

    // Update all markers
    function updateMarkers() {
      console.log('Updating markers...');
      
      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      let tsbdPos = null;
      let boundsPoints = [];

      // Handle TSBƒê
      if (inputs.tsbd.trim()) {
        try {
          const [lat, lng] = inputs.tsbd.split(',').map(x => parseFloat(x.trim()));
          if (!isNaN(lat) && !isNaN(lng)) {
            tsbdPos = { lat, lng };
            createCustomMarker(tsbdPos, "TSBƒê", "tsbd");
            boundsPoints.push([lat, lng]);
          }
        } catch (e) {
          console.error('L·ªói t·ªça ƒë·ªô TSBƒê:', e);
        }
      }

      // Handle TSSS
      ['tsss1', 'tsss2', 'tsss3'].forEach((id, index) => {
        const distElement = document.getElementById(`dist-${id}`);
        
        if (inputs[id].trim()) {
          try {
            const [lat, lng] = inputs[id].split(',').map(x => parseFloat(x.trim()));
            if (!isNaN(lat) && !isNaN(lng)) {
              const pos = { lat, lng };
              let distance = null;
              
              if (tsbdPos) {
                distance = calculateDistance(tsbdPos.lat, tsbdPos.lng, lat, lng);
                distElement.textContent = `üìè ${distance} km`;
              } else {
                distElement.textContent = '';
              }
              
              createCustomMarker(pos, `TSSS ${index + 1}`, id, distance);
              boundsPoints.push([lat, lng]);
            }
          } catch (e) {
            console.error(`L·ªói t·ªça ƒë·ªô ${id}:`, e);
            distElement.textContent = '';
          }
        } else {
          distElement.textContent = '';
        }
      });

      // Fit bounds
      if (boundsPoints.length > 0) {
        if (currentMap === 'google' && googleMap) {
          const bounds = new google.maps.LatLngBounds();
          boundsPoints.forEach(point => {
            bounds.extend({ lat: point[0], lng: point[1] });
          });
          googleMap.fitBounds(bounds);
          
          setTimeout(() => {
            if (googleMap.getZoom() > 18) {
              googleMap.setZoom(18);
            }
          }, 500);
        } else if (currentMap === 'leaflet' && leafletMap) {
          leafletMap.fitBounds(boundsPoints);
          setTimeout(() => {
            if (leafletMap.getZoom() > 18) {
              leafletMap.setZoom(18);
            }
          }, 500);
        }
      }
    }

    // Clear all data
    function clearAll() {
      console.log('Clearing all data...');
      
      document.getElementById("tsbd").value = '';
      document.getElementById("tsss1").value = '';
      document.getElementById("tsss2").value = '';
      document.getElementById("tsss3").value = '';
      
      // Clear Google markers
      Object.values(markers).forEach(marker => {
        if (marker.setMap) marker.setMap(null);
      });
      markers = {};
      
      // Clear Leaflet markers
      Object.values(leafletMarkers).forEach(marker => {
        if (leafletMap && marker) leafletMap.removeLayer(marker);
      });
      leafletMarkers = {};
      
      // Clear district info
      ['tsbd', 'tsss1', 'tsss2', 'tsss3'].forEach(id => {
        document.getElementById(`${id}-district`).textContent = '';
      });
      
      ['dist-tsss1', 'dist-tsss2', 'dist-tsss3'].forEach(id => {
        document.getElementById(id).textContent = '';
      });
      
      currentInputMode = 'tsbd';
      updateInputModeDisplay();
      
      showNotification('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu');
    }

    // Center map
    function centerMap() {
      if (currentMap === 'google' && googleMap) {
        googleMap.setCenter(defaultCenterGoogle);
        googleMap.setZoom(15);
      } else if (currentMap === 'leaflet' && leafletMap) {
        leafletMap.setView(defaultCenter, 15);
      }
      showNotification('üéØ ƒê√£ cƒÉn gi·ªØa b·∫£n ƒë·ªì');
    }

    // Get current location
    function getCurrentLocation() {
      if (navigator.geolocation) {
        showNotification('üìç ƒêang l·∫•y v·ªã tr√≠...', 'info');
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById(currentInputMode).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            checkDistrictForCoordinate(lat, lng, currentInputMode);
            updateMarkers();
            
            if (currentMap === 'google') {
              googleMap.setCenter({ lat, lng });
            } else {
              leafletMap.setView([lat, lng]);
            }
            
            showNotification('‚úÖ ƒê√£ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i');
          },
          (error) => {
            showNotification('‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ' + error.message, 'error');
          }
        );
      } else {
        showNotification('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation', 'error');
      }
    }

    // Screenshot functionality
    let currentScreenshotBlob = null;
    let currentScreenshotFilename = null;

    function takeScreenshot(format = 'png') {
      const hideControls = document.getElementById('hide-controls').checked;
      const addWatermark = document.getElementById('add-watermark').checked;
      const showLabels = document.getElementById('show-labels').checked;
      
      showLoading(true);
      
      // Add coordinate labels if enabled
      if (showLabels) {
        addCoordinateLabels();
      }
      
      // Hide controls if selected
      if (hideControls) {
        document.querySelector('.controls').style.display = 'none';
        document.getElementById('click-info').style.display = 'none';
      }

      setTimeout(() => {
        const options = {
          allowTaint: true,
          useCORS: true,
          scale: format === 'hd' ? 2 : 1,
          width: window.innerWidth,
          height: window.innerHeight,
          backgroundColor: '#ffffff',
          logging: false
        };

        html2canvas(document.body, options).then(canvas => {
          if (addWatermark) {
            addWatermarkToCanvas(canvas);
          }

          let mimeType, extension, quality;
          if (format === 'jpg') {
            mimeType = 'image/jpeg';
            extension = 'jpg';
            quality = 0.85;
          } else {
            mimeType = 'image/png';
            extension = 'png';
            quality = 1.0;
          }

          const tsbdCoords = document.getElementById('tsbd').value.trim();
          if (tsbdCoords) {
            const [lat, lng] = tsbdCoords.split(',').map(x => x.trim());
            currentScreenshotFilename = `BIDV_TSBD_${lat}_${lng}_${new Date().toISOString().slice(0,10)}.${extension}`;
          } else {
            currentScreenshotFilename = `BIDV_Map_${new Date().toISOString().slice(0,10)}.${extension}`;
          }

          canvas.toBlob((blob) => {
            currentScreenshotBlob = blob;
            
            const url = URL.createObjectURL(blob);
            showPreview(url);
            
            showLoading(false);

            if (hideControls) {
              document.querySelector('.controls').style.display = 'block';
              document.getElementById('click-info').style.display = 'block';
            }
            
            if (showLabels) {
              removeCoordinateLabels();
            }
            
          }, mimeType, quality);

        }).catch(error => {
          console.error('L·ªói ch·ª•p ·∫£nh:', error);
          
          showLoading(false);
          if (hideControls) {
            document.querySelector('.controls').style.display = 'block';
            document.getElementById('click-info').style.display = 'block';
          }
          if (showLabels) {
            removeCoordinateLabels();
          }
          
          showNotification('‚ùå L·ªói khi ch·ª•p ·∫£nh: ' + error.message, 'error');
        });
      }, 300);
    }

    function takeScreenshotHD() {
      takeScreenshot('hd');
    }

    // Add coordinate labels on map
    function addCoordinateLabels() {
      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      Object.entries(inputs).forEach(([key, value]) => {
        if (value.trim()) {
          const [lat, lng] = value.split(',').map(x => parseFloat(x.trim()));
          const type = key === 'tsbd' ? 'TSBƒê' : `TSSS ${key.slice(-1)}`;
          const district = document.getElementById(`${key}-district`).textContent;
          
          // Create floating label
          const label = document.createElement('div');
          label.className = 'coordinate-label';
          label.id = `label-${key}`;
          label.style.cssText = `
            position: fixed;
            top: ${50 + Object.keys(inputs).indexOf(key) * 80}px;
            right: 20px;
            background: rgba(0, 125, 120, 0.95);
            color: #f2c94c;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 999;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid #f2c94c;
            backdrop-filter: blur(5px);
          `;
          
          label.innerHTML = `
            <div>${type}</div>
            <div style="font-size: 10px;">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
            <div style="font-size: 10px;">${district.replace('üìç ', '')}</div>
          `;
          
          document.body.appendChild(label);
        }
      });
    }

    function removeCoordinateLabels() {
      document.querySelectorAll('.coordinate-label').forEach(label => {
        label.remove();
      });
    }

    // Enhanced watermark
    function addWatermarkToCanvas(canvas) {
      const ctx = canvas.getContext('2d');
      
      const tsbdCoords = document.getElementById('tsbd').value.trim();
      const tsssCoords = [
        document.getElementById('tsss1').value.trim(),
        document.getElementById('tsss2').value.trim(),
        document.getElementById('tsss3').value.trim()
      ].filter(coord => coord);

      const watermarkText = 'BIDV - B·∫£n ƒë·ªì TSBƒê & TSSS';
      const timestamp = new Date().toLocaleString('vi-VN');
      
      const scale = canvas.width / 1920;
      const fontSize = Math.max(16, 20 * scale);
      const smallFontSize = Math.max(12, 14 * scale);
      
      ctx.font = `bold ${fontSize}px Arial`;
      ctx.textAlign = 'left';
      
      const padding = 20 * scale;
      const lineHeight = smallFontSize * 1.3;
      
      // Build watermark content
      const watermarkLines = [watermarkText, timestamp];
      
      if (tsbdCoords) {
        const tsbdDistrict = document.getElementById('tsbd-district').textContent.replace('üìç ', '');
        watermarkLines.push(`TSBƒê: ${tsbdCoords}`);
        if (tsbdDistrict) watermarkLines.push(`     ${tsbdDistrict}`);
      }
      
      tsssCoords.forEach((coord, index) => {
        if (coord) {
          const distance = document.getElementById(`dist-tsss${index + 1}`).textContent;
          const district = document.getElementById(`tsss${index + 1}-district`).textContent.replace('üìç ', '');
          watermarkLines.push(`TSSS ${index + 1}: ${coord} ${distance}`);
          if (district) watermarkLines.push(`        ${district}`);
        }
      });

      // Calculate dimensions
      ctx.font = `bold ${fontSize}px Arial`;
      let maxWidth = ctx.measureText(watermarkText).width;
      
      ctx.font = `${smallFontSize}px Arial`;
      watermarkLines.slice(1).forEach(line => {
        maxWidth = Math.max(maxWidth, ctx.measureText(line).width);
      });

      const bgHeight = watermarkLines.length * lineHeight + padding;
      const bgWidth = maxWidth + padding * 2;
      
      // Draw background
      ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
      ctx.fillRect(
        canvas.width - bgWidth - padding,
        canvas.height - bgHeight - padding,
        bgWidth + padding,
        bgHeight
      );
      
      // Draw border
      ctx.strokeStyle = '#007d78';
      ctx.lineWidth = 2;
      ctx.strokeRect(
        canvas.width - bgWidth - padding,
        canvas.height - bgHeight - padding,
        bgWidth + padding,
        bgHeight
      );

      // Draw content
      let yPos = canvas.height - bgHeight - padding + fontSize;
      
      // Title
      ctx.font = `bold ${fontSize}px Arial`;
      ctx.fillStyle = '#007d78';
      ctx.fillText(
        watermarkText,
        canvas.width - bgWidth - padding/2,
        yPos
      );
      
      yPos += lineHeight;
      
      // Details
      ctx.font = `${smallFontSize}px Arial`;
      ctx.fillStyle = '#333';
      
      watermarkLines.slice(1).forEach(line => {
        ctx.fillText(
          line,
          canvas.width - bgWidth - padding/2,
          yPos
        );
        yPos += lineHeight;
      });

      // Add logo
      addLogoToCanvas(ctx, canvas, scale);
    }

    function addLogoToCanvas(ctx, canvas, scale) {
      const logoSize = 40 * scale;
      const logoX = canvas.width - logoSize * 4;
      const logoY = canvas.height - logoSize * 1.5;
      
      ctx.beginPath();
      ctx.arc(logoX, logoY, logoSize/2, 0, 2 * Math.PI);
      ctx.fillStyle = '#007d78';
      ctx.fill();
      
      ctx.font = `bold ${logoSize/3}px Arial`;
      ctx.fillStyle = 'white';
      ctx.textAlign = 'center';
      ctx.fillText('BIDV', logoX, logoY + logoSize/8);
    }

    // Preview and utility functions
    function showLoading(show) {
      document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    function showPreview(imageUrl) {
      const preview = document.getElementById('screenshot-preview');
      const image = document.getElementById('preview-image');
      
      image.src = imageUrl;
      preview.style.display = 'block';
    }

    function closePreview() {
      const preview = document.getElementById('screenshot-preview');
      preview.style.display = 'none';
      
      const image = document.getElementById('preview-image');
      if (image.src) {
        URL.revokeObjectURL(image.src);
      }
    }

    function downloadPreviewImage() {
      if (currentScreenshotBlob && currentScreenshotFilename) {
        const url = URL.createObjectURL(currentScreenshotBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentScreenshotFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification(`‚úÖ ƒê√£ t·∫£i xu·ªëng: ${currentScreenshotFilename}`);
        closePreview();
      }
    }

    function shareImage() {
      if (navigator.share && currentScreenshotBlob) {
        const file = new File([currentScreenshotBlob], currentScreenshotFilename, {
          type: currentScreenshotBlob.type
        });
        
        navigator.share({
          title: 'BIDV - B·∫£n ƒë·ªì TSBƒê & TSSS',
          text: 'B·∫£n ƒë·ªì v·ªã tr√≠ t√†i s·∫£n t·ª´ BIDV',
          files: [file]
        }).then(() => {
          showNotification('‚úÖ ƒê√£ chia s·∫ª ·∫£nh!');
        }).catch(err => {
          copyImageToClipboard();
        });
      } else {
        copyImageToClipboard();
      }
    }

    function copyImageToClipboard() {
      if (navigator.clipboard && currentScreenshotBlob) {
        navigator.clipboard.write([
          new ClipboardItem({
            [currentScreenshotBlob.type]: currentScreenshotBlob
          })
        ]).then(() => {
          showNotification('‚úÖ ƒê√£ copy ·∫£nh v√†o clipboard!');
        }).catch(() => {
          downloadPreviewImage();
        });
      } else {
        downloadPreviewImage();
      }
    }

    // URL sharing functions
    function loadFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const data = urlParams.get('data');
      
      if (data) {
        try {
          const decoded = JSON.parse(atob(data));
          Object.keys(decoded).forEach(key => {
            if (document.getElementById(key)) {
              document.getElementById(key).value = decoded[key];
            }
          });
          setTimeout(updateMarkers, 500);
          showNotification('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ URL');
        } catch (e) {
          console.error('L·ªói load t·ª´ URL:', e);
        }
      }
    }

    function generateShareURL() {
      const data = {
        tsbd: document.getElementById('tsbd').value,
        tsss1: document.getElementById('tsss1').value,
        tsss2: document.getElementById('tsss2').value,
        tsss3: document.getElementById('tsss3').value
      };
      
      const encoded = btoa(JSON.stringify(data));
      const url = `${window.location.origin}${window.location.pathname}?data=${encoded}`;
      
      document.getElementById('share-url').style.display = 'block';
      document.getElementById('share-url-input').value = url;
      showNotification('üîó ƒê√£ t·∫°o link chia s·∫ª');
    }

    function copyToClipboard() {
      const input = document.getElementById('share-url-input');
      if (input.value) {
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showNotification('‚úÖ ƒê√£ copy link chia s·∫ª!');
      } else {
        showNotification('‚ö†Ô∏è Ch∆∞a c√≥ link ƒë·ªÉ copy!', 'error');
      }
    }

    // Export functions
    function exportToCSV() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
        return;
      }

      const csvContent = data.map(row => 
        Object.values(row).map(val => `"${val}"`).join(',')
      ).join('\n');
      
      const headers = Object.keys(data[0]).map(key => `"${key}"`).join(',');
      const fullCSV = headers + '\n' + csvContent;

      const blob = new Blob(['\ufeff' + fullCSV], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `BIDV_ToaDo_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showNotification('üìÑ ƒê√£ xu·∫•t file CSV');
    }

    function exportToExcel() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(data);
      
      const colWidths = Object.keys(data[0]).map(key => ({ wch: Math.max(key.length, 15) }));
      ws['!cols'] = colWidths;
      
      XLSX.utils.book_append_sheet(wb, ws, "T·ªça ƒë·ªô BIDV");
      XLSX.writeFile(wb, `BIDV_ToaDo_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      showNotification('üìä ƒê√£ xu·∫•t file Excel');
    }

    function collectData() {
      const data = [];
      const timestamp = new Date().toLocaleString('vi-VN');

      const inputs = {
        tsbd: document.getElementById("tsbd").value,
        tsss1: document.getElementById("tsss1").value,
        tsss2: document.getElementById("tsss2").value,
        tsss3: document.getElementById("tsss3").value
      };

      Object.entries(inputs).forEach(([key, value]) => {
        if (value.trim()) {
          const [lat, lng] = value.split(',').map(x => parseFloat(x.trim()));
          const type = key === 'tsbd' ? 'TSBƒê' : `TSSS ${key.slice(-1)}`;
          const district = document.getElementById(`${key}-district`).textContent.replace('üìç ', '');
          
          let distance = '';
          if (key !== 'tsbd' && inputs.tsbd.trim()) {
            const [tsbdLat, tsbdLng] = inputs.tsbd.split(',').map(x => parseFloat(x.trim()));
            distance = calculateDistance(tsbdLat, tsbdLng, lat, lng) + ' km';
          }

          data.push({
            'Lo·∫°i': type,
            'Vƒ© ƒë·ªô (Latitude)': lat.toFixed(6),
            'Kinh ƒë·ªô (Longitude)': lng.toFixed(6),
            'Kho·∫£ng c√°ch t·ª´ TSBƒê': distance,
            'Ph∆∞·ªùng/Qu·∫≠n': district,
            'Th·ªùi gian': timestamp
          });
        }
      });

      return data;
    }

    function exportToGoogleSheets() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
        return;
      }

      const headers = Object.keys(data[0]).join(',');
      const csvData = data.map(row => Object.values(row).map(val => `"${val}"`).join(',')).join('\n');
      const csvContent = headers + '\n' + csvData;

      const sheetsUrl = `https://docs.google.com/spreadsheets/create`;
      
      navigator.clipboard.writeText(csvContent).then(() => {
        showNotification('‚úÖ D·ªØ li·ªáu CSV ƒë√£ copy! S·∫Ω m·ªü Google Sheets...', 'info');
        
        setTimeout(() => {
          window.open(sheetsUrl, '_blank');
          alert(`üìã H∆∞·ªõng d·∫´n:
1. D√°n (Ctrl+V) d·ªØ li·ªáu v√†o Google Sheets
2. Ch·ªçn "Data" ‚Üí "Split text to columns"
3. Ch·ªçn "Comma" l√†m delimiter`);
        }, 1000);
      }).catch(() => {
        exportToCSV();
      });
    }

    // Google My Maps functions
    function createMyMap() {
      const data = collectData();
      if (data.length === 0) {
        showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt t·ªça ƒë·ªô!', 'error');
        return;
      }

      let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <n>BIDV - B·∫£n ƒë·ªì TSBƒê &amp; TSSS</n>
    <description>T·∫°o t·ª´ BIDV Map Tool</description>
    <Style id="tsbd-style">
      <IconStyle>
        <color>ff4cc9f2</color>
        <scale>1.2</scale>
      </IconStyle>
    </Style>
    <Style id="tsss-style">
      <IconStyle>
        <color>ff007d78</color>
        <scale>1.0</scale>
      </IconStyle>
    </Style>`;

      data.forEach(item => {
        const styleId = item['Lo·∫°i'].includes('TSBƒê') ? 'tsbd-style' : 'tsss-style';
        kmlContent += `
    <Placemark>
      <n>${item['Lo·∫°i']}</n>
      <description>
        T·ªça ƒë·ªô: ${item['Vƒ© ƒë·ªô (Latitude)']}, ${item['Kinh ƒë·ªô (Longitude)']}
        ${item['Kho·∫£ng c√°ch t·ª´ TSBƒê'] ? `&lt;br/&gt;Kho·∫£ng c√°ch: ${item['Kho·∫£ng c√°ch t·ª´ TSBƒê']}` : ''}
        &lt;br/&gt;ƒê·ªãa ch·ªâ: ${item['Ph∆∞·ªùng/Qu·∫≠n']}
        &lt;br/&gt;Th·ªùi gian: ${item['Th·ªùi gian']}
      </description>
      <styleUrl>#${styleId}</styleUrl>
      <Point>
        <coordinates>${item['Kinh ƒë·ªô (Longitude)']},${item['Vƒ© ƒë·ªô (Latitude)']},0</coordinates>
      </Point>
    </Placemark>`;
      });

      kmlContent += `
  </Document>
</kml>`;

      const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `BIDV_MyMap_${new Date().toISOString().split('T')[0]}.kml`;
      a.click();

      setTimeout(() => {
        showNotification('‚úÖ File KML ƒë√£ t·∫£i xu·ªëng!');
        alert(`üìã H∆∞·ªõng d·∫´n t·∫°o My Map:
1. Truy c·∫≠p: https://mymaps.google.com
2. Nh·∫•n "CREATE A NEW MAP"
3. Nh·∫•n "Import" ‚Üí Ch·ªçn file KML v·ª´a t·∫£i
4. ƒê·∫∑t t√™n v√† m√¥ t·∫£ cho b·∫£n ƒë·ªì
5. Nh·∫•n "Share" ƒë·ªÉ chia s·∫ª c√¥ng khai`);
      }, 1000);
    }

    function openMyMaps() {
      window.open('https://mymaps.google.com', '_blank');
    }

    function shareMyMap() {
      const mapUrl = prompt(`üîó Nh·∫≠p URL Google My Maps c·ªßa b·∫°n:
(L·∫•y t·ª´ n√∫t "Share" trong My Maps)`, '');
      
      if (mapUrl && mapUrl.trim()) {
        document.getElementById('my-maps-info').style.display = 'block';
        document.getElementById('my-maps-link').href = mapUrl;
        document.getElementById('my-maps-link').textContent = 'Xem My Map ‚Üí';
        
        localStorage.setItem('bidv-my-maps-url', mapUrl);
        showNotification('‚úÖ ƒê√£ l∆∞u link My Maps!');
      }
    }

    // File loading functions
    function loadFromFile() {
      document.getElementById('file-input').click();
    }

    function handleFileLoad(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let data = [];
          
          if (file.name.endsWith('.csv')) {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index];
              });
              data.push(row);
            }
          } else if (file.name.endsWith('.xlsx')) {
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            data = XLSX.utils.sheet_to_json(worksheet);
          }

          loadDataToForm(data);
          
        } catch (error) {
          showNotification('‚ùå L·ªói khi ƒë·ªçc file: ' + error.message, 'error');
        }
      };

      if (file.name.endsWith('.xlsx')) {
        reader.readAsBinaryString(file);
      } else {
        reader.readAsText(file, 'utf-8');
      }
    }

    function loadDataToForm(data) {
      clearAll();
      
      data.forEach(row => {
        const type = row['Lo·∫°i'] || row['Type'] || '';
        const lat = row['Vƒ© ƒë·ªô (Latitude)'] || row['Latitude'] || '';
        const lng = row['Kinh ƒë·ªô (Longitude)'] || row['Longitude'] || '';
        
        if (lat && lng) {
          const coordinates = `${lat}, ${lng}`;
          
          if (type.includes('TSBƒê')) {
            document.getElementById('tsbd').value = coordinates;
          } else if (type.includes('TSSS 1')) {
            document.getElementById('tsss1').value = coordinates;
          } else if (type.includes('TSSS 2')) {
            document.getElementById('tsss2').value = coordinates;
          } else if (type.includes('TSSS 3')) {
            document.getElementById('tsss3').value = coordinates;
          }
        }
      });
      
      updateMarkers();
      showNotification(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng ${data.length} t·ªça ƒë·ªô t·ª´ file!`);
    }

    // Notification system
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      
      let bgColor;
      switch(type) {
        case 'error': bgColor = '#f44336'; break;
        case 'info': bgColor = '#2196f3'; break;
        default: bgColor = '#4caf50';
      }
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: ${bgColor};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
        max-width: 350px;
        font-size: 14px;
        backdrop-filter: blur(5px);
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      const timeout = type === 'info' ? 4000 : 3000;
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, timeout);
    }

    // Event listeners
    ['tsbd', 'tsss1', 'tsss2', 'tsss3'].forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener('focus', () => {
        currentInputMode = id;
        updateInputModeDisplay();
      });
      input.addEventListener('input', updateMarkers);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === 's') {
        event.preventDefault();
        takeScreenshot('png');
      }
      
      if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'S') {
        event.preventDefault();
        takeScreenshotHD();
      }
      
      if (event.key === 'Escape') {
        closePreview();
      }
      
      if (event.key === ' ' && event.target === document.body) {
        event.preventDefault();
        switchToNextInput();
      }
    });

    // Touch optimizations
    if ('ontouchstart' in window) {
      document.addEventListener('touchstart', (e) => {
        if (e.target.closest('.controls')) {
          e.preventDefault();
        }
      }, { passive: false });
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded, initializing...');
      
      // Initialize with Leaflet by default
      setTimeout(() => {
        initLeafletMap();
        updateInputModeDisplay();
      }, 100);
      
      // Load saved data
      const savedUrl = localStorage.getItem('bidv-my-maps-url');
      if (savedUrl) {
        document.getElementById('my-maps-info').style.display = 'block';
        document.getElementById('my-maps-link').href = savedUrl;
        document.getElementById('my-maps-link').textContent = 'Xem My Map ‚Üí';
      }
      
      // Show welcome message
      setTimeout(() => {
        showNotification('üéâ Ch√†o m·ª´ng! Shortcuts: Ctrl+S (ch·ª•p ·∫£nh), Space (chuy·ªÉn ch·∫ø ƒë·ªô)', 'info');
      }, 2000);
    });

    // Google Maps callback (if API loads)
    window.initMap = function() {
      console.log('Google Maps API loaded successfully');
    };

    // Handle Google Maps API errors
    window.gm_authFailure = function() {
      console.error('Google Maps API authentication failed');
      updateApiStatus('‚ùå Google Maps API key kh√¥ng h·ª£p l·ªá', 'error');
    };

  </script>

  <!-- Google Maps API (optional) -->
  <script>
    // Load Google Maps API only if needed
    function loadGoogleMapsAPI() {
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyARhMzsywQPyQbrbgS6aFVb5sg7eSV34oA&callback=initMap&language=vi&region=VN';
      script.async = true;
      script.defer = true;
      script.onerror = function() {
        console.log('Google Maps API failed to load');
        updateApiStatus('‚ö†Ô∏è Google Maps API kh√¥ng kh·∫£ d·ª•ng (ch·ªâ OSM)', 'error');
      };
      document.head.appendChild(script);
    }

    // Uncomment the line below to enable Google Maps
    // loadGoogleMapsAPI();
  </script>
</body>
</html>
